{
    "version": "https://jsonfeed.org/version/1",
    "title": "hexo-blog • All posts by \"数据库\" tag",
    "description": "record some markdown",
    "home_page_url": "https://ceilzcx.github.io/hexo-blog",
    "items": [
        {
            "id": "https://ceilzcx.github.io/hexo-blog/2022/07/29/database/elasticsearch8/",
            "url": "https://ceilzcx.github.io/hexo-blog/2022/07/29/database/elasticsearch8/",
            "title": "elasticsearch8",
            "date_published": "2022-07-29T16:11:24.000Z",
            "content_html": "<h1 id=\"elasticsearch8\"><a class=\"markdownIt-Anchor\" href=\"#elasticsearch8\">#</a> Elasticsearch8+</h1>\n<blockquote>\n<p>ECE 认证工程师备考</p>\n</blockquote>\n<h2 id=\"安装\"><a class=\"markdownIt-Anchor\" href=\"#安装\">#</a> 安装</h2>\n<p>使用  <code>Ubuntu16 </code> 系统</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install elasticsearch</span><br><span class=\"line\">/etc/elasticsearch | /var/log/elasticsearch | /usr/share/elasticsearch</span><br><span class=\"line\">wget https://xxxx/elasticsearch.tar.gz</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">===================================================================================</span><br><span class=\"line\">elasticsearch.keystore 密文文件，不小心误删</span><br><span class=\"line\">===================================================================================</span><br><span class=\"line\">./bin/elasticsearch-keystore create</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./elasticsearch-setup-passwords interactive</span><br><span class=\"line\"></span><br><span class=\"line\">=====================================================================================</span><br><span class=\"line\">Failed to authenticate user &#x27;elastic&#x27; against http://10.0.16.8:9200/_security/_authenticate?pretty</span><br><span class=\"line\">Possible causes include:</span><br><span class=\"line\"> * The password for the &#x27;elastic&#x27; user has already been changed on this cluster</span><br><span class=\"line\"> * Your elasticsearch node is running against a different keystore</span><br><span class=\"line\">   This tool used the keystore at /home/ubuntu/elasticsearch-8.3.2/config/elasticsearch.keystore</span><br><span class=\"line\"></span><br><span class=\"line\">You can use the `elasticsearch-reset-password` CLI tool to reset the password of the &#x27;elastic&#x27; user</span><br><span class=\"line\">=====================================================================================</span><br><span class=\"line\"></span><br><span class=\"line\">修改 elasticsearch.yml 的 xpack.security.enabled: false</span><br><span class=\"line\">删除 .security-7 索引</span><br><span class=\"line\">重新设置 xpack.security.enabled: true</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">===================================================================================</span><br><span class=\"line\">kibana.yml配置不支持使用elastic用户名，使用其他用户名</span><br><span class=\"line\">===================================================================================</span><br><span class=\"line\">比较合理的 elasticsearch-setup-password 脚本会设置 kibana_system 的用户和密码</span><br><span class=\"line\"></span><br><span class=\"line\">elasticsearch.username: &quot;kibana_system&quot;</span><br><span class=\"line\">elasticsearch.password: &quot;xxx&quot;</span><br></pre></td></tr></table></figure>\n<h2 id=\"data-management\"><a class=\"markdownIt-Anchor\" href=\"#data-management\">#</a> <strong>Data Management</strong></h2>\n<h3 id=\"define-an-index-that-satisfies-a-given-set-of-requirements-定义一个满足条件的索引\"><a class=\"markdownIt-Anchor\" href=\"#define-an-index-that-satisfies-a-given-set-of-requirements-定义一个满足条件的索引\">#</a> Define an index that satisfies a given set of requirements —— 定义一个满足条件的索引</h3>\n<ul>\n<li>analysis</li>\n<li>setting</li>\n<li>mapper</li>\n</ul>\n<h3 id=\"define-and-use-an-index-template-for-a-given-pattern-that-satisfies-a-given-set-of-requirements\"><a class=\"markdownIt-Anchor\" href=\"#define-and-use-an-index-template-for-a-given-pattern-that-satisfies-a-given-set-of-requirements\">#</a> Define and use an index template for a given pattern that satisfies a given set of requirements</h3>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT index-test</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;mappings&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  \t<span class=\"comment\">// 默认为true</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;date_detection&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span></span><br><span class=\"line\">    <span class=\"comment\">// 设置时间格式</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;dynamic_date_formats&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"string\">&quot;MM/dd/yyyy&quot;</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">    <span class=\"comment\">// 开启number类型检测，整数检测为long类型，浮点数检测为float类型</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;numeric_detection&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT test_index</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;mappings&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;dynamic_templates&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      \t<span class=\"comment\">// 自定义名称</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;my_template&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"comment\">// 匹配条件(match_mapping_type、match、unmatch、path:e.g 类似对象、path_unmatch)</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;match&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;name*&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;mapping&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;keyword&quot;</span></span><br><span class=\"line\">          <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"define-and-use-a-dynamic-template-that-satisfies-a-given-set-of-requirements\"><a class=\"markdownIt-Anchor\" href=\"#define-and-use-a-dynamic-template-that-satisfies-a-given-set-of-requirements\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L2R5bmFtaWMtdGVtcGxhdGVzLmh0bWw=\">Define and use a dynamic template that satisfies a given set of requirements</span></h3>\n<blockquote>\n<p>8 + 版本后  <code>_template</code>  逐渐被废弃，改为  <code>_component_template</code>  和  <code>_index_template</code></p>\n</blockquote>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT _index_template/my_template_name</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;template&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t\t<span class=\"attr\">&quot;mappings&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t\t<span class=\"attr\">&quot;settings&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">\t<span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"define-an-index-lifecycle-management-policy-for-a-time-series-index\"><a class=\"markdownIt-Anchor\" href=\"#define-an-index-lifecycle-management-policy-for-a-time-series-index\">#</a> Define an Index Lifecycle Management policy for a time-series index</h3>\n<blockquote>\n<p>kibana： Stack Management &gt;&gt;&gt; Index Lifecycle Management</p>\n</blockquote>\n<h3 id=\"define-an-index-template-that-creates-a-new-data-stream\"><a class=\"markdownIt-Anchor\" href=\"#define-an-index-template-that-creates-a-new-data-stream\">#</a> Define an index template that creates a new data stream</h3>\n<p>类似 ILM</p>\n<p>need</p>\n<ul>\n<li>\n<p>a matching index template</p>\n</li>\n<li>\n<p>a  <code>@timestamp</code>  field</p>\n</li>\n<li></li>\n</ul>\n<p>原理：read all indices (now + back) /write now/newest index</p>\n<p>索引格式： <code>.ds-&lt;data-stream&gt;-&lt;yyyy.MM.dd&gt;-000001</code></p>\n<p>add a new document： not use  <code>PUT /&lt;target&gt;/_doc/&lt;_id&gt;</code>  ，use  <code>PUT /&lt;target&gt;/_create/&lt;_id&gt;</code></p>\n<h3 id=\"use-the-data-visualizer-to-upload-a-text-file-into-elasticsearch不考\"><a class=\"markdownIt-Anchor\" href=\"#use-the-data-visualizer-to-upload-a-text-file-into-elasticsearch不考\">#</a> Use the Data Visualizer to upload a text file into Elasticsearch（不考）</h3>\n<p>kibana &gt;&gt;&gt; machine learning  &gt;&gt;&gt; data visualizer</p>\n<h2 id=\"searching-data\"><a class=\"markdownIt-Anchor\" href=\"#searching-data\">#</a> Searching Data</h2>\n<h3 id=\"write-and-execute-a-search-query-for-terms-andor-phrases-in-one-or-more-fields-of-an-index\"><a class=\"markdownIt-Anchor\" href=\"#write-and-execute-a-search-query-for-terms-andor-phrases-in-one-or-more-fields-of-an-index\">#</a> Write and execute a search query for terms and/or phrases in one or more fields of an index</h3>\n<p><strong>match、term、match_phrase 的区别</strong></p>\n<ul>\n<li><code>match</code>  查询会进行分词，匹配到单个即可</li>\n<li><code>term</code>  查询不会分词，必须完全匹配（适用 keyword 类型，类似 like）</li>\n<li><code>match_phrase</code>  查询会分词，必须完全匹配（适用 text 类型，类似 like）</li>\n</ul>\n<h5 id=\"boolean-query\"><a class=\"markdownIt-Anchor\" href=\"#boolean-query\">#</a> Boolean query</h5>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST _search</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;query&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;bool&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;must&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;term&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;field&quot;</span> <span class=\"punctuation\">:</span> <span class=\"string\">&quot;value&quot;</span> <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;filter&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;term&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;field&quot;</span> <span class=\"punctuation\">:</span> <span class=\"string\">&quot;value&quot;</span> <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;must_not&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;range&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;age&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;gte&quot;</span> <span class=\"punctuation\">:</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span> <span class=\"attr\">&quot;lte&quot;</span> <span class=\"punctuation\">:</span> <span class=\"number\">20</span> <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;should&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;term&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;field1&quot;</span> <span class=\"punctuation\">:</span> <span class=\"string\">&quot;value1&quot;</span> <span class=\"punctuation\">&#125;</span> <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;term&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;field2&quot;</span> <span class=\"punctuation\">:</span> <span class=\"string\">&quot;value2&quot;</span> <span class=\"punctuation\">&#125;</span> <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;minimum_should_match&quot;</span> <span class=\"punctuation\">:</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;boost&quot;</span> <span class=\"punctuation\">:</span> <span class=\"number\">1.0</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p><code>minimum_should_match</code>  存在 should 时默认为 1，否则默认为 0</p>\n<p><code>boost</code> ：计算分数时使用</p>\n<p><code>bool.filter</code> ：不计算分数</p>\n<p><code>_name</code> ：每一个 top query 都可以添加，response 的 <code>matched_queries</code>  查看结果满足哪个 query。</p>\n<h5 id=\"boosting-query-constant-score-query\"><a class=\"markdownIt-Anchor\" href=\"#boosting-query-constant-score-query\">#</a> Boosting query &amp; Constant score query</h5>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_search</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;query&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;boosting&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;positive&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;term&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;text&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;apple&quot;</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"comment\">// 匹配的document减negative_boost的分数</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;negative&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;term&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;text&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;pie tart fruit crumble tree&quot;</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;negative_boost&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0.5</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;constant_score&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"comment\">// 只有 filter 这一种</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;filter&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;term&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;user.id&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;kimchy&quot;</span> <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"comment\">// 匹配到数据分数指定为boost值</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;boost&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1.2</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"disjunction-max-query\"><a class=\"markdownIt-Anchor\" href=\"#disjunction-max-query\">#</a> Disjunction max query</h5>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_search</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;query&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;dis_max&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"comment\">// 满足多个 query 匹配的文档，根据 tie_breaker 增加分数</span></span><br><span class=\"line\">      <span class=\"comment\">// 0 &lt;= tie_breaker &lt;= 1</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;tie_breaker&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0.4</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;boost&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1.2</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;queries&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;match&quot;</span><span class=\"punctuation\">:</span><span class=\"punctuation\">&#123;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;match&quot;</span><span class=\"punctuation\">:</span><span class=\"punctuation\">&#123;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">      <span class=\"punctuation\">]</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"intervals-query\"><a class=\"markdownIt-Anchor\" href=\"#intervals-query\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS84LjMvcXVlcnktZHNsLWludGVydmFscy1xdWVyeS5odG1s\">Intervals query</span></h5>\n<p>精确控制查询的 terms 顺序、terms 之间的距离以及包含关系的灵活控制</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_search</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;query&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;intervals&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;message&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;all_of&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"comment\">// 按顺序匹配 xxxvalue1xxxvalue2xxx可以被查询到，xxxvalue2xxxvalue1xxx的文档不能配查询</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;ordered&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"comment\">// value1和value2的间距，0代表只能匹配xxxvalue1value2xxx的文档</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;max_gaps&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;intervals&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">            <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">              <span class=\"attr\">&quot;match&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">                <span class=\"attr\">&quot;query&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;value1&quot;</span></span><br><span class=\"line\">              <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">            <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">            <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">              <span class=\"attr\">&quot;match&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">                <span class=\"attr\">&quot;query&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;value2&quot;</span></span><br><span class=\"line\">              <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">            <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">          <span class=\"punctuation\">]</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"match-query\"><a class=\"markdownIt-Anchor\" href=\"#match-query\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS84LjMvcXVlcnktZHNsLW1hdGNoLXF1ZXJ5Lmh0bWw=\">Match query</span></h5>\n<blockquote>\n<p>匹配 text、number、date or boolean value</p>\n</blockquote>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _search</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;query&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;match&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;message&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;query&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;cuury&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"comment\">// 模糊匹配 cuury 可以匹配到 curry</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;fuzziness&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"comment\">// fuzzy前缀n位不更改</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;prefix_length&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"comment\">// &quot;a b&quot; &gt;&gt;&gt; or &gt;&gt;&gt; a or b </span></span><br><span class=\"line\">        <span class=\"comment\">// &quot;a b&quot; &gt;&gt;&gt; and &gt;&gt;&gt; a and b</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;operator&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;or/and&quot;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"match-boolean-prefix\"><a class=\"markdownIt-Anchor\" href=\"#match-boolean-prefix\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS84LjMvcXVlcnktZHNsLW1hdGNoLWJvb2wtcHJlZml4LXF1ZXJ5Lmh0bWw=\">Match boolean prefix</span></h5>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_search</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;query&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;match_bool_prefix&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;message&quot;</span> <span class=\"punctuation\">:</span> <span class=\"string\">&quot;quick brown f&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">等价于</span><br><span class=\"line\">GET /_search</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;query&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;bool&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;should&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;term&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;message&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;quick&quot;</span> <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;term&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;message&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;brown&quot;</span> <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;prefix&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;message&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;f&quot;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">]</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"match-phrase-query-match-phrase-prefix-query\"><a class=\"markdownIt-Anchor\" href=\"#match-phrase-query-match-phrase-prefix-query\">#</a> match phrase query &amp; match phrase prefix query</h5>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET my-index<span class=\"number\">-00002</span>/_search</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;query&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;match_phrase&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;field&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;value&quot;</span>     </span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"combined-fields\"><a class=\"markdownIt-Anchor\" href=\"#combined-fields\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS84LjMvcXVlcnktZHNsLWNvbWJpbmVkLWZpZWxkcy1xdWVyeS5odG1s\">Combined fields</span></h5>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET _search</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;query&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;combined_fields&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;query&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;quility.com Brogan Dante&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"comment\">// 查询 city 和 email 字段，^2代表匹配这个字段的boost=2</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;fields&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"string\">&quot;city^2&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;email&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"comment\">// 默认为 or，or/and</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;operator&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;or&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p>nested query</p>\n<h3 id=\"write-and-execute-a-search-query-that-is-a-boolean-combination-of-multiple-queries-and-filters\"><a class=\"markdownIt-Anchor\" href=\"#write-and-execute-a-search-query-that-is-a-boolean-combination-of-multiple-queries-and-filters\">#</a> Write and execute a search query that is a Boolean combination of multiple queries and filters</h3>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET my-index<span class=\"number\">-000001</span>/_msearch</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;query&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;match_all&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span> <span class=\"attr\">&quot;from&quot;</span> <span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"attr\">&quot;size&quot;</span> <span class=\"punctuation\">:</span> <span class=\"number\">10</span><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;query&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;match_all&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;index&quot;</span> <span class=\"punctuation\">:</span> <span class=\"string\">&quot;my-index-000002&quot;</span><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;query&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;match_all&quot;</span> <span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p>返回的 response 数组结果集，每个元素为一个查询结果</p>\n<h3 id=\"search-template\"><a class=\"markdownIt-Anchor\" href=\"#search-template\">#</a> search template</h3>\n<h3 id=\"write-an-asynchronous-search\"><a class=\"markdownIt-Anchor\" href=\"#write-an-asynchronous-search\">#</a> Write an asynchronous search</h3>\n<p>异步搜索</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST  my_index/_async_search</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">GET _sql/async/&lt;id&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"write-and-execute-metric-and-bucket-aggregations\"><a class=\"markdownIt-Anchor\" href=\"#write-and-execute-metric-and-bucket-aggregations\">#</a> Write and execute metric and bucket aggregations</h3>\n<ul>\n<li>\n<p>前置条件：【doc_values: true】</p>\n</li>\n<li>\n<p>不能用于 <code>text</code>  类型</p>\n</li>\n<li>\n<p>缓存，aggs 执行会将高频率的数据进行缓存，使用 <code>&quot;size&quot;:0</code>  有效减少不必要的缓存，缓存适用于相同的 <code>preference string</code></p>\n</li>\n</ul>\n<p>demo search aggs 如下</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// typed_keys: 原本return name, 现在return type#name</span></span><br><span class=\"line\">GET my_index/_search?typed_keys</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;size&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span>\t<span class=\"comment\">// 只返回 aggs 结果</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;aggs&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t\t<span class=\"attr\">&quot;my-first-agg-name&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t\t\t<span class=\"attr\">&quot;type (terms)&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t\t\t\t<span class=\"attr\">&quot;field&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;my-field&quot;</span></span><br><span class=\"line\">\t\t\t<span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// 元数据：元数据也会带上这个field</span></span><br><span class=\"line\">\t\t\t<span class=\"attr\">&quot;meta&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">       \t \t\t<span class=\"attr\">&quot;my-metadata-field&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;foo&quot;</span></span><br><span class=\"line\">      \t\t<span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// sub aggs</span></span><br><span class=\"line\">\t\t\t<span class=\"attr\">&quot;aggs&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t\t\t\t<span class=\"attr\">&quot;my-first-sub-agg-name&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t\t\t\t<span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">\t\t\t<span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">\t\t<span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// 多个 aggs, 返回多个 result</span></span><br><span class=\"line\">\t\t<span class=\"attr\">&quot;my-second-agg-name&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t\t<span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">\t<span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"metric-aggs\"><a class=\"markdownIt-Anchor\" href=\"#metric-aggs\">#</a> metric aggs</h4>\n<p>计算指标：Max/Min、Average、Sum</p>\n<p>不支持 sub-aggregations</p>\n<ul>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3NlYXJjaC1hZ2dyZWdhdGlvbnMtbWV0cmljcy1ib3hwbG90LWFnZ3JlZ2F0aW9uLmh0bWw=\">Boxplot</span></p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">&quot;boxplot&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;field&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;load_time&quot;</span> </span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// response</span></span><br><span class=\"line\"><span class=\"attr\">&quot;aggregations&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;load_time_boxplot&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;min&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0.0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;max&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">990.0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"comment\">// 第一个四分位数（前一半数据的中位数）</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;q1&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">165.0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"comment\">// 第二个四分位数（中位数）</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;q2&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">445.0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"comment\">// 第三个四分位数（后一半数据的中位数）</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;q3&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">725.0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;lower&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0.0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;upper&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">990.0</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li></li>\n</ul>\n<h4 id=\"bucket-aggs\"><a class=\"markdownIt-Anchor\" href=\"#bucket-aggs\">#</a> bucket aggs</h4>\n<p>支持 sub-aggregations</p>\n<ul>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS84LjMvc2VhcmNoLWFnZ3JlZ2F0aW9ucy1idWNrZXQtYWRqYWNlbmN5LW1hdHJpeC1hZ2dyZWdhdGlvbi5odG1s\">Adjacency matrix</span></p>\n<p>【向量】filter A B C -&gt; return A B C A&amp;B A&amp;C B&amp;C</p>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS84LjMvc2VhcmNoLWFnZ3JlZ2F0aW9ucy1idWNrZXQtYXV0b2RhdGVoaXN0b2dyYW0tYWdncmVnYXRpb24uaHRtbA==\">Auto-interval date histogram</span></p>\n<p>自定义 <code>buckets</code> ，es 自动划分需要区间</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">&quot;auto_date_histogram&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;field&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;date&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;buckets&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS84LjMvc2VhcmNoLWFnZ3JlZ2F0aW9ucy1idWNrZXQtY2hpbGRyZW4tYWdncmVnYXRpb24uaHRtbA==\">Children</span></p>\n<p>适用于 <code>join</code>  类型</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">&quot;aggs&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;join-aggs&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;children&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;answer&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS84LjMvc2VhcmNoLWFnZ3JlZ2F0aW9ucy1idWNrZXQtY29tcG9zaXRlLWFnZ3JlZ2F0aW9uLmh0bWw=\">Composite</span></p>\n<p>组合，合并多个 aggs 查询，source1：A1、A2，source2：B1、B2 -&gt; A1B1、A1B2、A2B1、A2B2 的查询结果</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">&quot;aggs&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;my-aggs-name&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;composite&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;sources&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">          <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;name01&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">              <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">                <span class=\"attr\">&quot;field&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;field-name&quot;</span></span><br><span class=\"line\">              <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">            <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">          <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;name02&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">              <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">                <span class=\"attr\">&quot;field&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;field-name&quot;</span></span><br><span class=\"line\">              <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">            <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">          <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">        <span class=\"punctuation\">]</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS84LjMvc2VhcmNoLWFnZ3JlZ2F0aW9ucy1idWNrZXQtaGlzdG9ncmFtLWFnZ3JlZ2F0aW9uLmh0bWw=\">Histogram</span></p>\n<blockquote>\n<p>直方图 / 柱状图</p>\n<p>bucket_key = Math.floor((value - offset) / interval) * interval + offset</p>\n</blockquote>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">&quot;histogram&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;field&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;field-name&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"comment\">// 间隔</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;interval&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">5</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"comment\">// 过滤 count &lt; min_doc_count 的区间</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;min_doc_count&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3NlYXJjaC1hZ2dyZWdhdGlvbnMtYnVja2V0LWRhdGVoaXN0b2dyYW0tYWdncmVnYXRpb24uaHRtbA==\">Date histogram</span></p>\n<blockquote>\n<p>date 作为 field type 的特殊 histogram</p>\n<p>bucket_key = Math.floor(value / interval) * interval</p>\n</blockquote>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3NlYXJjaC1hZ2dyZWdhdGlvbnMtYnVja2V0LXJhbmdlLWFnZ3JlZ2F0aW9uLmh0bWw=\">Range</span></p>\n<blockquote>\n<p>范围聚合查询，from &lt;= value &lt; to</p>\n</blockquote>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">&quot;aggs&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;price_ranges&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;range&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;keyed&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"comment\">// 可以查询script field</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;field&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;price&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;ranges&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">        <span class=\"comment\">// 可以没有to，也可以没有from</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;to&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">100.0</span> <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"comment\">// 范围可以重叠</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;from&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">80.0</span><span class=\"punctuation\">,</span> <span class=\"attr\">&quot;to&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">200.0</span> <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;from&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">200.0</span> <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">]</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3NlYXJjaC1hZ2dyZWdhdGlvbnMtYnVja2V0LWRhdGVyYW5nZS1hZ2dyZWdhdGlvbi5odG1s\">Date range</span></p>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3NlYXJjaC1hZ2dyZWdhdGlvbnMtYnVja2V0LWdsb2JhbC1hZ2dyZWdhdGlvbi5odG1s\">Global</span></p>\n<blockquote>\n<p>定义一个单独包含全部数据的 bucket，使得当前聚合不受 query 查询的影响（全部数据作为聚合目标）</p>\n</blockquote>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /sales/_search?size=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;query&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;match&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;t-shirt&quot;</span> <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;aggs&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"comment\">// 全部商品平均价格（match_all）</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;all_products&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;global&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">      <span class=\"attr\">&quot;aggs&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span>     </span><br><span class=\"line\">      <span class=\"attr\">&quot;avg_price&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;avg&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;field&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;price&quot;</span> <span class=\"punctuation\">&#125;</span> <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"comment\">//  t-shirt商品平均价格（query有关）</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;t_shirts&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;avg&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;field&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;price&quot;</span> <span class=\"punctuation\">&#125;</span> <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3NlYXJjaC1hZ2dyZWdhdGlvbnMtYnVja2V0LW1pc3NpbmctYWdncmVnYXRpb24uaHRtbA==\">Missing</span></p>\n<p>缺少字段或者字段值为 null 的 <code>document</code>  缺少 <code>bucket</code> ，通过 <code>missing</code>  聚合统计</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">&quot;aggs&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;products_without_a_price&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;missing&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;field&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;price&quot;</span> <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3NlYXJjaC1hZ2dyZWdhdGlvbnMtYnVja2V0LWlwcHJlZml4LWFnZ3JlZ2F0aW9uLmh0bWw=\">IP prefix</span> 和 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3NlYXJjaC1hZ2dyZWdhdGlvbnMtYnVja2V0LWlwcmFuZ2UtYWdncmVnYXRpb24uaHRtbA==\">IP range</span></p>\n<blockquote>\n<p>IP 地址相关的聚合，<span class=\"exturl\" data-url=\"aHR0cDovL3h4eC54eHgueHh4Lnh4eA==\">xxx.xxx.xxx.xxx</span></p>\n</blockquote>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3NlYXJjaC1hZ2dyZWdhdGlvbnMtcmFuZG9tLXNhbXBsZXItYWdncmVnYXRpb24uaHRtbA==\">Random sampler</span></p>\n<blockquote>\n<p>随机取样聚合，0 &lt; probability &lt; 0.5 || probability = 1</p>\n<p>随机取集合 * probability 的集合，每次结果可能不相同</p>\n</blockquote>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;aggregations&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;sampling&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;random_sampler&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;probability&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0.1</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;aggs&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;price_percentiles&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;percentiles&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;field&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;taxful_total_price&quot;</span></span><br><span class=\"line\">          <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li></li>\n</ul>\n<h4 id=\"pipeline-aggs\"><a class=\"markdownIt-Anchor\" href=\"#pipeline-aggs\">#</a> pipeline aggs</h4>\n<h3 id=\"other\"><a class=\"markdownIt-Anchor\" href=\"#other\">#</a> Other</h3>\n<h4 id=\"ccrcross-cluster-replication-ccscross-cluster-search\"><a class=\"markdownIt-Anchor\" href=\"#ccrcross-cluster-replication-ccscross-cluster-search\">#</a> CCR（Cross-cluster replication） &amp; CCS（Cross-cluster search）</h4>\n<p>配置  <code>elasticsearch.yml</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">transport.host:</span> <span class=\"string\">xxx.xxx.xxx.xxx</span></span><br><span class=\"line\"><span class=\"attr\">transport.port:</span> <span class=\"number\">9300</span></span><br></pre></td></tr></table></figure>\n<p>证书问题</p>\n<p>1）使用相同的 CA 证书：复制  <code>ca.crt</code>  和  <code>ca.key</code></p>\n<p>2）使用不同证书</p>\n<h5 id=\"创建集群远程连接\"><a class=\"markdownIt-Anchor\" href=\"#创建集群远程连接\">#</a> 创建集群远程连接</h5>\n<p>Stack Management &gt;&gt;&gt; Remote Clusters</p>\n<p>或通过 Dev Tools 实现</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">PUT _cluster/settings</span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;persistent&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;cluster.remote&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;remote_cluster&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;seeds&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">          <span class=\"string\">&quot;192.168.0.8:9300&quot;</span></span><br><span class=\"line\">        <span class=\"punctuation\">]</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"配置跨集群复制\"><a class=\"markdownIt-Anchor\" href=\"#配置跨集群复制\">#</a> 配置跨集群复制</h5>\n<p>Stack Management &gt;&gt;&gt; Cross Cluster Replication</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Remote cluster</strong></td>\n<td>添加的集群名称</td>\n</tr>\n<tr>\n<td><strong>Leader index</strong></td>\n<td>待迁移的索引。</td>\n</tr>\n<tr>\n<td><strong>Follower index</strong></td>\n<td>迁移数据生成的索引。索引名称不可重复。</td>\n</tr>\n</tbody>\n</table>\n",
            "tags": [
                "数据库"
            ]
        },
        {
            "id": "https://ceilzcx.github.io/hexo-blog/2022/05/30/database/rocksDB/",
            "url": "https://ceilzcx.github.io/hexo-blog/2022/05/30/database/rocksDB/",
            "title": "rocksDB",
            "date_published": "2022-05-30T10:40:40.000Z",
            "content_html": "<h2 id=\"rocksdb\"><a class=\"markdownIt-Anchor\" href=\"#rocksdb\">#</a> RocksDB</h2>\n<p>适用环境：内存、<strong>Flash</strong>、hard disks、HDFS</p>\n<h3 id=\"数据结构\"><a class=\"markdownIt-Anchor\" href=\"#数据结构\">#</a> 数据结构</h3>\n<ul>\n<li>\n<p>memtable（<strong>内存</strong>数据结构）</p>\n</li>\n<li>\n<p>sstfile（磁盘）</p>\n</li>\n</ul>\n<p>有序存储，方便查询</p>\n<ul>\n<li>logfile（顺序写）</li>\n</ul>\n<p>数据先写入  <code>memtable</code> ，部分请求内容写入  <code>logfile</code> （WAL：Write-Ahead Logging）</p>\n<p><code>memtable</code>  内存满之后，执行 flush 操作，将数据转移到  <code>sstfile</code> ，同时删除 logfile 的数据</p>\n<p>RocksDB 的 key 和 value 完全是 byte stream（无长度限制）</p>\n<p><strong>DB 的所有数据按照 key 有序存储</strong>（因此  <code>iterator</code>  可以支持 rangeScan 查询）， <code>compare</code>  方法可以用户自定义</p>\n<p><code>Snapshot</code>  可以创建一个时间点的快照（ <code>Get</code>  和  <code>Iterator</code>  可以执行在某一个  <code>Snapshot</code>  上）</p>\n<h4 id=\"读放大-和-写放大\"><a class=\"markdownIt-Anchor\" href=\"#读放大-和-写放大\">#</a> 读放大 和 写放大</h4>\n<ul>\n<li>\n<p>数据存入内存，构建成一棵树</p>\n</li>\n<li>\n<p>内存数据越来越大，flush 到磁盘</p>\n</li>\n<li>\n<p>磁盘定期执行 merge 操作，合并成为一棵更大的树（L0 → LN，L0 的热度最高，LN 的热度最低）</p>\n</li>\n</ul>\n<p>读取数据需要一步步从内存到硬盘，因此称为读放大。</p>\n<h4 id=\"同步写-和-异步写\"><a class=\"markdownIt-Anchor\" href=\"#同步写-和-异步写\">#</a> 同步写 和 异步写</h4>\n<ul>\n<li>同步写：写入磁盘返回</li>\n<li>异步写：写入内存返回，写入磁盘是异步操作</li>\n</ul>\n<p>异步写操作系统崩溃会丢掉部分数据（一般不会发生），同步写效率比异步写差千倍左右。</p>\n<h4 id=\"事务transations\"><a class=\"markdownIt-Anchor\" href=\"#事务transations\">#</a> 事务（Transations）</h4>\n<p>支持乐观和悲观锁</p>\n<h4 id=\"column-family\"><a class=\"markdownIt-Anchor\" href=\"#column-family\">#</a> Column Family</h4>\n<blockquote>\n<p>列族</p>\n</blockquote>\n<p>每个 key 都与唯一的列族结合</p>\n<p>跨列族的原子性操作</p>\n<p>快速删除 / 添加列族（<strong>共享 WAL 日志，不共享 <code>memtable</code>  和 <code>table</code>  文件</strong>）</p>\n<p>一个列族 flush 后，创建新的 WAL 日志，老的 WAL 不删除，等到所有的列族都 flush 后才会删除老的 WAL 文件</p>\n",
            "tags": [
                "数据库"
            ]
        },
        {
            "id": "https://ceilzcx.github.io/hexo-blog/2021/10/12/database/database/",
            "url": "https://ceilzcx.github.io/hexo-blog/2021/10/12/database/database/",
            "title": "database",
            "date_published": "2021-10-12T11:06:30.000Z",
            "content_html": "<h2 id=\"build-a-simple-database\"><a class=\"markdownIt-Anchor\" href=\"#build-a-simple-database\">#</a> build a simple database</h2>\n<h3 id=\"一-设计结构\"><a class=\"markdownIt-Anchor\" href=\"#一-设计结构\">#</a> 一、设计结构</h3>\n<h4 id=\"1tokenizer\"><a class=\"markdownIt-Anchor\" href=\"#1tokenizer\">#</a> 1） <code>Tokenizer</code></h4>\n<p>拆分语法</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zaGFyZGluZ3NwaGVyZS5hcGFjaGUub3JnL2RvY3VtZW50L2N1cnJlbnQvY24vZmVhdHVyZXMvc2hhcmRpbmcvcHJpbmNpcGxlL3BhcnNlLw==\">解析引擎 :: ShardingSphere (apache.org)</span></p>\n<p>涉及到 AST（抽象语法树）</p>\n<p>词法分析：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYWxpeXVuLmNvbS9hcnRpY2xlLzcxOTc5\">https://developer.aliyun.com/article/71979</span></p>\n<p>不采用纯手写，使用第三方工具：</p>\n<ul>\n<li>\n<p><code>antlr</code> ：自动生成语法树的开源语法分析器，可以适用 Java、C、C++ 等多语言。</p>\n</li>\n<li>\n<p><code>yacc/lex</code> ：参考 <a href=\"https://github.com/westes/flex/\"> <code>Github</code> </a></p>\n</li>\n</ul>\n<h4 id=\"2parser\"><a class=\"markdownIt-Anchor\" href=\"#2parser\">#</a> 2）Parser</h4>\n<p>解析语法</p>\n<p>prepare_statement()</p>\n<p>美团使用 SQL 解析：<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNzA5MzQ2Mw==\">https://zhuanlan.zhihu.com/p/37093463</span></p>\n<h4 id=\"3code-generator\"><a class=\"markdownIt-Anchor\" href=\"#3code-generator\">#</a> 3）Code Generator</h4>\n<p>execute_statement()</p>\n<h4 id=\"4存储结构\"><a class=\"markdownIt-Anchor\" href=\"#4存储结构\">#</a> 4）存储结构</h4>\n<p>内存型：Map</p>\n<p>MongoDB：JSON</p>\n<p>MySQL：B-Tree</p>\n<h4 id=\"5pager\"><a class=\"markdownIt-Anchor\" href=\"#5pager\">#</a> 5）Pager</h4>\n<p>disk 的分页机制，可以参考 MySQL</p>\n<h4 id=\"6os和disk\"><a class=\"markdownIt-Anchor\" href=\"#6os和disk\">#</a> 6）OS 和 disk</h4>\n<h3 id=\"二-设计的难题\"><a class=\"markdownIt-Anchor\" href=\"#二-设计的难题\">#</a> 二、设计的难题</h3>\n<ul>\n<li>\n<p>如何拆分？空格分隔、分号结束</p>\n</li>\n<li>\n<p>解析</p>\n</li>\n<li>\n<p>data 如何存到 disk</p>\n<p>MySQL 采取两个文件存储：一个存放表结构；一个存放表数据</p>\n<p>数据分页、数据检查（check）</p>\n</li>\n<li>\n<p>log 日志</p>\n</li>\n<li>\n<p>事物提交和回滚</p>\n</li>\n<li>\n<p>集群</p>\n</li>\n</ul>\n<h3 id=\"三-思路\"><a class=\"markdownIt-Anchor\" href=\"#三-思路\">#</a> 三、思路</h3>\n<ul>\n<li><code>Tokenizer</code>  和  <code>AST</code>  设计难度偏大，不如采取类似  <code>elastic search</code>  的形式，采取  <code>RestFul</code>  +  <code>JSON</code>  的形式，这样不要考虑词法和解析，而且  <code>GET</code> ， <code>POST</code> ， <code>DELETE</code> ， <code>UPDATE</code>  和数据库的增删改查操作正好对应。</li>\n<li>借鉴  <code>MongoDB</code></li>\n</ul>\n<h3 id=\"四-数据库规则\"><a class=\"markdownIt-Anchor\" href=\"#四-数据库规则\">#</a> 四、数据库规则</h3>\n<h4 id=\"41-数据库和表操作\"><a class=\"markdownIt-Anchor\" href=\"#41-数据库和表操作\">#</a> 4.1、数据库和表操作</h4>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">db.<span class=\"title function_\">list</span>()\t\t\t\t\t<span class=\"comment\">// 获取所有database</span></span><br><span class=\"line\">db.<span class=\"title function_\">create</span>(<span class=\"string\">&#x27;demo&#x27;</span>, &#123;&#125;)\t\t<span class=\"comment\">// 创建database，第二个参数为config (定义编码等)</span></span><br><span class=\"line\">db.<span class=\"title function_\">tableList</span>()\t\t\t\t<span class=\"comment\">// 获取所有table</span></span><br><span class=\"line\">db.<span class=\"title function_\">createTable</span>(<span class=\"string\">&#x27;demo&#x27;</span>, &#123;&#125;)  <span class=\"comment\">// 创建table，第二个参数为config (定义编码等)</span></span><br><span class=\"line\">db.<span class=\"title function_\">use</span>(<span class=\"string\">&#x27;test&#x27;</span>)\t\t\t\t<span class=\"comment\">// 使用test数据库</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"42-数据操作\"><a class=\"markdownIt-Anchor\" href=\"#42-数据操作\">#</a> 4.2、数据操作</h4>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">db.<span class=\"title function_\">table</span>(<span class=\"string\">&#x27;test&#x27;</span>).<span class=\"title function_\">select</span>(&#123;&#125;)\t\t\t\t\t\t\t<span class=\"comment\">// 查询</span></span><br><span class=\"line\">db.<span class=\"title function_\">table</span>(<span class=\"string\">&#x27;test&#x27;</span>).<span class=\"title function_\">insertOne</span>(&#123;&#125;)\t\t\t\t\t\t<span class=\"comment\">// 添加一条</span></span><br><span class=\"line\">db.<span class=\"title function_\">table</span>(<span class=\"string\">&#x27;test&#x27;</span>).<span class=\"title function_\">insertMany</span>([])\t\t\t\t\t\t<span class=\"comment\">// 批量添加</span></span><br><span class=\"line\">db.<span class=\"title function_\">table</span>(<span class=\"string\">&#x27;test&#x27;</span>).<span class=\"title function_\">updateOne</span>(&#123;&#125;, &#123;<span class=\"attr\">$set</span>:&#123;&#125;&#125;)\t\t\t<span class=\"comment\">// 修改一条</span></span><br><span class=\"line\">db.<span class=\"title function_\">table</span>(<span class=\"string\">&#x27;test&#x27;</span>).<span class=\"title function_\">updateMany</span>(&#123;&#125;, &#123;<span class=\"attr\">$set</span>:&#123;&#125;&#125;)\t\t\t<span class=\"comment\">// 批量修改</span></span><br><span class=\"line\">db.<span class=\"title function_\">table</span>(<span class=\"string\">&#x27;test&#x27;</span>).<span class=\"title function_\">deleteOne</span>(&#123;&#125;)\t\t\t\t\t\t<span class=\"comment\">// 删除一条</span></span><br><span class=\"line\">db.<span class=\"title function_\">table</span>(<span class=\"string\">&#x27;test&#x27;</span>).<span class=\"title function_\">deleteMany</span>(&#123;&#125;)\t\t\t\t\t\t<span class=\"comment\">// 删除全部</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"五-数据库结构\"><a class=\"markdownIt-Anchor\" href=\"#五-数据库结构\">#</a> 五、数据库结构</h3>\n<h4 id=\"参考-mongodb\"><a class=\"markdownIt-Anchor\" href=\"#参考-mongodb\">#</a> 参考  <code>MongoDB</code></h4>\n<p>数据 —— disk 和缓存</p>\n<p>线程一：接收  <code>JavaScript</code>  解析的语句，执行操作，操作缓存</p>\n<p>线程二：将缓存的数据生成  <code>journal</code> ，保存在硬盘，频率  <code>100ms</code>  一次</p>\n<p>线程三：将日志数据同步到硬盘数据区，频率  <code>60s</code>  一次</p>\n<h4 id=\"参考-mysql\"><a class=\"markdownIt-Anchor\" href=\"#参考-mysql\">#</a> 参考  <code>MySQL</code></h4>\n<p>数据存储应该没有缓存的概念，数据直接存储到硬盘。</p>\n<p>查询的优化：创建索引（B+Tree）、<strong>页结构</strong></p>\n<p>一个数据库就是一个文件夹：一张表有两个文件，一张记录表定义（ <code>.frm</code> ），一张保存数据（ <code>.idb</code> ）</p>\n<h4 id=\"参考-redis\"><a class=\"markdownIt-Anchor\" href=\"#参考-redis\">#</a> 参考  <code>Redis</code></h4>\n<p>redis 有持久化机制 —— RDB 和 AOF</p>\n<p>RDB：将缓存数据复制一份一模一样的，另起一个线程保存到磁盘。（数据存在延迟，而且同步一份，需要很多内容）</p>\n<p>AOF：将操作以日志的方式记录。（次、秒、不记录）</p>\n<h4 id=\"参考-sqlite\"><a class=\"markdownIt-Anchor\" href=\"#参考-sqlite\">#</a> 参考  <code>sqlite</code></h4>\n<p>一个数据库对应一个文件，文件划分为大小一致的页面。</p>\n<p>通过 B 树和二维链表。页面作为 B 树的叶子节点或者链表的节点</p>\n<h3 id=\"其他参考资料\"><a class=\"markdownIt-Anchor\" href=\"#其他参考资料\">#</a> 其他（参考资料）</h3>\n<ul>\n<li>\n<p>MySQL（查询）缓存机制，默认开启，<strong>不建议使用</strong>，对 select 语句进行 Hash 计算并存储，Query Hash 存储 hash 值和结果地址。</p>\n<p>1、使用 hash，必须保证完全一致，大小写也会使得 Hash 结果不一致</p>\n<p>2、表中任何数据或者结构变化都会情况表相关所有缓存</p>\n<p>3、通过 session 保存，多个 client 可以共享同一个缓存</p>\n</li>\n<li></li>\n</ul>\n",
            "tags": [
                "数据库"
            ]
        },
        {
            "id": "https://ceilzcx.github.io/hexo-blog/2021/07/15/database/redis/",
            "url": "https://ceilzcx.github.io/hexo-blog/2021/07/15/database/redis/",
            "title": "redis",
            "date_published": "2021-07-15T15:59:38.000Z",
            "content_html": "<h2 id=\"redis数据库\"><a class=\"markdownIt-Anchor\" href=\"#redis数据库\">#</a> Redis 数据库</h2>\n",
            "tags": [
                "数据库"
            ]
        },
        {
            "id": "https://ceilzcx.github.io/hexo-blog/2021/07/15/database/mysql/",
            "url": "https://ceilzcx.github.io/hexo-blog/2021/07/15/database/mysql/",
            "title": "mysql",
            "date_published": "2021-07-15T15:59:33.000Z",
            "content_html": "<h2 id=\"mysql数据库\"><a class=\"markdownIt-Anchor\" href=\"#mysql数据库\">#</a> MySQL 数据库</h2>\n<h3 id=\"二-函数\"><a class=\"markdownIt-Anchor\" href=\"#二-函数\">#</a> 二、函数</h3>\n<h4 id=\"21-递归\"><a class=\"markdownIt-Anchor\" href=\"#21-递归\">#</a> 2.1、递归</h4>\n<p>mysql 的递归比较繁琐，需要通过函数实现，返回的是集合，通过  <code>FIND_IN_SET</code>  进行操作。</p>\n<p>注：递归调用消耗大量时间，在实现中宁可在代码中采用递归，也不要在 SQL 中使用递归。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create function getChildrenOrg(teamId INT)</span><br><span class=\"line\">    returns varchar(4000)</span><br><span class=\"line\">BEGIN</span><br><span class=\"line\">    DECLARE oTemp VARCHAR(4000);</span><br><span class=\"line\">    DECLARE oTempChild VARCHAR(4000);</span><br><span class=\"line\"></span><br><span class=\"line\">    SET oTemp = &#x27;&#x27;;</span><br><span class=\"line\">    SET oTempChild = CAST(teamId AS CHAR);</span><br><span class=\"line\"></span><br><span class=\"line\">    WHILE oTempChild IS NOT NULL</span><br><span class=\"line\">        DO</span><br><span class=\"line\">            SET oTemp = CONCAT(oTemp,&#x27;,&#x27;,oTempChild);</span><br><span class=\"line\">            SELECT GROUP_CONCAT(team_id) INTO oTempChild FROM team WHERE FIND_IN_SET(parent_id, oTempChild) &gt; 0;</span><br><span class=\"line\">        END WHILE;</span><br><span class=\"line\">    RETURN oTemp;</span><br><span class=\"line\">END</span><br></pre></td></tr></table></figure>\n<h4 id=\"22-now\"><a class=\"markdownIt-Anchor\" href=\"#22-now\">#</a> 2.2 NOW</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select NOW(), NOW(3)</span><br></pre></td></tr></table></figure>\n<p><code>NOW(3)</code> : 获得当前时间，包括毫秒值</p>\n<h3 id=\"三-主从复制\"><a class=\"markdownIt-Anchor\" href=\"#三-主从复制\">#</a> 三、主从复制</h3>\n<h4 id=\"31-类型\"><a class=\"markdownIt-Anchor\" href=\"#31-类型\">#</a> 3.1、类型</h4>\n<ul>\n<li>\n<p>基于语句的复制：将修改数据的 SQL 记录到  <code>binlog</code>  中。从库读取  <code>binlog</code>  写入中继日志  <code>relayLog</code>  中，复制日志时，从库会启动一个<strong>工作线程</strong>，然后将其放入数据库。</p>\n<p>优点：只记录修改数据，日志不大，解决 IO。</p>\n<p>缺点：数据可能存在不一致，例：同步过程主数据库挂了</p>\n</li>\n<li>\n<p>基于行数据的复制：只记录行数据的修改。</p>\n<p>缺点：中间过程全部丢失，产生大量日志（例：alter table）</p>\n</li>\n<li>\n<p>混合复制：一般的复制使用 STATEMENT 模式保存 binlog，对于 STATEMENT 模式无法复制的操作使用 ROW 模式保存 binlog</p>\n</li>\n</ul>\n<h4 id=\"32-模式\"><a class=\"markdownIt-Anchor\" href=\"#32-模式\">#</a> 3.2、模式</h4>\n<ul>\n<li>异步复制模式：主服务器启动 I/O 线程，将数据写到 binlog 中返回给客户端数据更新成功，不考虑数据是否同步。效率高，但数据一致性存在风险。</li>\n<li>同步复制模式：主服务器执行执行完客户端提交的事物后，等待从库执行完后，才返回执行成功。等待过程中，线程被阻塞，性能较慢。</li>\n<li>半同步复制模式：master 的 dump 线程通知从库，从库执行完成后，发送 ACK，主库接收到一个标志码（ACK）后，返回成功。与同步不同的是，只需要一个从库同步成功就返回成功。</li>\n</ul>\n<h3 id=\"四-事务隔离级别\"><a class=\"markdownIt-Anchor\" href=\"#四-事务隔离级别\">#</a> 四、事务隔离级别</h3>\n<h4 id=\"41-查看和修改事务隔离级别\"><a class=\"markdownIt-Anchor\" href=\"#41-查看和修改事务隔离级别\">#</a> 4.1、查看和修改事务隔离级别</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select @@transaction_isolation;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"mysql-select-transaction.png\" alt=\"mysql-select-transaction\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">update global transaction isolation REPEATABLE READ;</span><br><span class=\"line\">-- global：全局修改</span><br><span class=\"line\">-- session：本次回话修改</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"mysql-update-transaction.png\" alt=\"mysql-update-transaction\"></p>\n<h4 id=\"42-隔离级别\"><a class=\"markdownIt-Anchor\" href=\"#42-隔离级别\">#</a> 4.2、隔离级别</h4>\n<ul>\n<li>\n<p>读未提交（READ UNCOMMITTED）</p>\n<p>读未提交会读到另一个事务未提交的数据，产生脏读，不可重复读数据。一个事务的 update 操作可能会影响另一个事务。</p>\n<p>如下图，可以看到第一个事务修改完后，第二个事务直接可以 select 修改后的值</p>\n<p><img data-src=\"read-uncommitted-1.png\" alt=\"read-uncommitted-1\"></p>\n<p><img data-src=\"read-uncommitted-2.png\" alt=\"read-uncommitted-2\"></p>\n</li>\n<li>\n<p>读提交（READ COMMITTED）</p>\n<p>解决脏读的问题，出现不可重复读。一个事务可以读取另一个事务提交后的数据。一个事务的 update 操作可能会影响另一个事务。</p>\n<p>如下图，可以看到第一个事务 update 后，第二个事务查询的还是原来的数据，等到第一个事务提交后，第二个事务查询的就是第一个事务修改后的数据</p>\n<p><img data-src=\"read-committed-1.png\" alt=\"read-committed-1\"></p>\n<p><img data-src=\"read-committed-2.png\" alt=\"read-committed-2\"></p>\n</li>\n<li>\n<p>可重复读（REPEATABLE READ）</p>\n<p>解决了不可重复读和脏读的问题。但是存在换读的问题（一个事务新增了一条 id=1 的数据，这时另一个事务也新增了一条 id=1 的数据并提交，第一个事务 select 时会发现不存在 id=1 的数据，报主键冲突的错误）。</p>\n<p><img data-src=\"repeatable-read-1.png\" alt=\"repeatable-read-1\"></p>\n<p><img data-src=\"repeatable-read-2.png\" alt=\"repeatable-read-2\"></p>\n</li>\n<li>\n<p>串行化（SERIALIZABLE）</p>\n<p>暂无</p>\n</li>\n</ul>\n<h3 id=\"五-日志binlog\"><a class=\"markdownIt-Anchor\" href=\"#五-日志binlog\">#</a> 五、日志（binlog）</h3>\n<h4 id=\"51使用日志进行数据还原\"><a class=\"markdownIt-Anchor\" href=\"#51使用日志进行数据还原\">#</a> 5.1 使用日志进行数据还原</h4>\n<p>日志未打开，win10 在 my.ini 文件的 [mysqld] 下面添加</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">log_bin<span class=\"operator\">=</span>mysql<span class=\"operator\">-</span>bin</span><br><span class=\"line\">binlog<span class=\"operator\">-</span>format<span class=\"operator\">=</span><span class=\"type\">ROW</span></span><br><span class=\"line\">server<span class=\"operator\">-</span>id<span class=\"operator\">=</span><span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n<p>查找 MySQL 当前 binlog 的配置情况，<strong>第一行 ON 代表日志已经打开</strong>。</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> variables <span class=\"keyword\">like</span> <span class=\"string\">&#x27;%log_bin%&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"mysql-binlog-variables.png\" alt=\"mysql-binlog-variables\"></p>\n<p>查看日志文件的使用情况（日志名称、大小 bit、是否加密）</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"type\">binary</span> logs;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"mysql-binlog-show-1.png\" alt=\"mysql-binlog-show-1\"></p>\n<p>查看当前正在使用的日志情况，后续的 DDL 操作都会记录在当前日志中。</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> master status;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"mysql-binlog-show-2.png\" alt=\"mysql-binlog-show-2\"></p>\n<p>执行一些测试的 SQL 语句，可以看到创建一个数据库 test2，在数据库中创建了一张表 test，模拟不小心删除了 test2 数据库。</p>\n<p><img data-src=\"mysql-test-1.png\" alt=\"mysql-test-1\"></p>\n<p>在 binlog 中查找之前执行的 SQL 语句</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> binlog events <span class=\"keyword\">in</span> <span class=\"string\">&#x27;binlog.000012&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"mysql-binlog-show-3.png\" alt=\"mysql-binlog-show-3\"></p>\n<p>第二列的 1300… 表示所在的位置（行数），将这几行数据复制到一个 sql 文件，执行该文件即可恢复数据。</p>\n<p>注：根据需求，可以在恢复数据的时候关闭日志。等到数据恢复后，重新打开日志</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">set</span> sql_log_bin<span class=\"operator\">=</span><span class=\"number\">0</span>;\t#临时关闭日志</span><br><span class=\"line\"><span class=\"keyword\">set</span> sql_log_bin<span class=\"operator\">=</span><span class=\"number\">1</span>;\t#打开日志</span><br></pre></td></tr></table></figure>\n<p>注意这里是 shell，不是 MySQL 中执行</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysqlbinlog --start-position=1300 --stop-position=1757 ./binlog.000012 &gt;./bin.sql</span><br></pre></td></tr></table></figure>\n<p>注：这里运行可能会报  <code>unknown variable 'default-character-set=utf8'</code>  的错误。加上运行参数  <code>--no-default</code>  ，或者修改配置文件。</p>\n<h3 id=\"六-索引\"><a class=\"markdownIt-Anchor\" href=\"#六-索引\">#</a> 六、索引</h3>\n<h4 id=\"61-聚簇索引\"><a class=\"markdownIt-Anchor\" href=\"#61-聚簇索引\">#</a> 6.1 聚簇索引</h4>\n<ul>\n<li>如果设置了主键，主键为聚簇索引</li>\n<li>否则第一个 NOT NULL and UNIQUE 的字段为聚簇索引</li>\n<li>默认创建一个隐藏的 row_id 为聚簇索引</li>\n</ul>\n<p>聚簇索引指向（存储）的数据是行记录（页结构）</p>\n<p><strong>InnoDB 必须包含一个聚簇索引</strong></p>\n<h4 id=\"62-普通索引\"><a class=\"markdownIt-Anchor\" href=\"#62-普通索引\">#</a> 6.2 普通索引</h4>\n<blockquote>\n<p>二级索引，非聚簇索引</p>\n</blockquote>\n<p>叶子节点存储聚簇索引字段的值</p>\n<h4 id=\"63-回表查询\"><a class=\"markdownIt-Anchor\" href=\"#63-回表查询\">#</a> 6.3 回表查询</h4>\n<blockquote>\n<p>先通过普通索引的值定位聚簇索引值，再通过聚簇索引的值定位行记录数据，需要扫描两次索引 B + 树，它的性能较扫一遍索引树更低。</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"operator\">/</span><span class=\"operator\">/</span> <span class=\"keyword\">user</span>表包含 id，name，age字段，其中id为主键（聚簇索引），age为普通索引</span><br><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> <span class=\"keyword\">user</span> <span class=\"keyword\">where</span> age <span class=\"operator\">=</span> <span class=\"number\">20</span>;</span><br></pre></td></tr></table></figure>\n<p>通过 age 的普通索引查询对应的 id，然后回表查询 id，获得对应的行（两次查询）</p>\n<h4 id=\"64-索引覆盖\"><a class=\"markdownIt-Anchor\" href=\"#64-索引覆盖\">#</a> 6.4 索引覆盖</h4>\n<blockquote>\n<p>只需要在一棵索引树上就能获取 SQL 所需的所有列数据，无需回表，速度快。</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> id, age <span class=\"keyword\">from</span> <span class=\"keyword\">user</span> <span class=\"keyword\">where</span> age <span class=\"operator\">=</span> <span class=\"number\">20</span>;</span><br></pre></td></tr></table></figure>\n<p><strong>如何实现覆盖索引？</strong></p>\n<ul>\n<li>\n<p>创建联合索引</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">create</span> index idx_age_name <span class=\"keyword\">on</span> <span class=\"keyword\">user</span>(`age`,`name`);</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>适用范围：全表 count、分页查询</p>\n<p>索引结构：age 和 name 放在一个节点，和普通的 B+Tree 一致，比较大小时（<strong>最左匹配原则</strong>：先比较 age，再比较 name）</p>\n<h3 id=\"七-视图\"><a class=\"markdownIt-Anchor\" href=\"#七-视图\">#</a> 七、视图</h3>\n<blockquote>\n<p>作为一张虚拟表，本身不存储数据，作为一条 select 语句存储在数据字典中</p>\n<p>简化设计，可能提高性能、也可能降低性能</p>\n</blockquote>\n",
            "tags": [
                "数据库"
            ]
        },
        {
            "id": "https://ceilzcx.github.io/hexo-blog/2021/07/15/database/elasticsearch/",
            "url": "https://ceilzcx.github.io/hexo-blog/2021/07/15/database/elasticsearch/",
            "title": "elasticsearch",
            "date_published": "2021-07-15T15:59:27.000Z",
            "content_html": "<h2 id=\"一-介绍\"><a class=\"markdownIt-Anchor\" href=\"#一-介绍\">#</a> 一、介绍</h2>\n<blockquote>\n<p>分布式文档存储，采用 JSON 文档</p>\n</blockquote>\n<ul>\n<li>\n<p>集群中多个节点，文档分布在整个集群，任何节点可以访问文档。</p>\n</li>\n<li>\n<p>存储文档后，<strong>近实时</strong>地编入索引并完成搜索。</p>\n</li>\n<li>\n<p>倒排索引。支持全文搜索、精确搜索等</p>\n</li>\n<li>\n<p>无模式的能力（不明确字段类型的情况，映射为合适的类型）</p>\n</li>\n<li>\n<p>可拓展性和弹性（集群 -&gt; 节点 -&gt; 分片、索引）</p>\n<ul>\n<li>主分片和副本分片</li>\n<li>主分片创建时固定，副本分片可以随身更改</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"其他\"><a class=\"markdownIt-Anchor\" href=\"#其他\">#</a> 其他</h3>\n<h4 id=\"快捷键\"><a class=\"markdownIt-Anchor\" href=\"#快捷键\">#</a> 快捷键</h4>\n<ul>\n<li><code>ctrl + i</code>  ：格式化代码</li>\n<li><code>ctrl + enter</code> ：运行代码</li>\n</ul>\n<h2 id=\"二-安装和配置es\"><a class=\"markdownIt-Anchor\" href=\"#二-安装和配置es\">#</a> 二、安装和配置 ES</h2>\n<blockquote>\n<p>ES + kibana + plugins</p>\n</blockquote>\n<p>待补充</p>\n<h3 id=\"各配置项\"><a class=\"markdownIt-Anchor\" href=\"#各配置项\">#</a> 各配置项</h3>\n<ul>\n<li>单个分片的最大文档数： <code>2^32-1</code> （约 20 亿）。官方建议分片的大小控制在  <code>30GB - 50GB</code></li>\n</ul>\n<h2 id=\"三-api\"><a class=\"markdownIt-Anchor\" href=\"#三-api\">#</a> 三、API</h2>\n<h3 id=\"1-集群cluster\"><a class=\"markdownIt-Anchor\" href=\"#1-集群cluster\">#</a> 1. 集群（cluster）</h3>\n<h4 id=\"11-集群查询address-_local\"><a class=\"markdownIt-Anchor\" href=\"#11-集群查询address-_local\">#</a> 1.1、集群查询（address /_local）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_nodes/_local</span><br><span class=\"line\"></span><br><span class=\"line\">response:</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;_nodes&quot; : &#123;</span><br><span class=\"line\">    &quot;total&quot; : 1,</span><br><span class=\"line\">    &quot;successful&quot; : 1,</span><br><span class=\"line\">    &quot;failed&quot; : 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</span><br><span class=\"line\">  &quot;nodes&quot; : &#123;</span><br><span class=\"line\">    &quot;IebqG-UeTgykeuDuZsMz-w&quot; : &#123;</span><br><span class=\"line\">      &quot;name&quot; : &quot;SK-20210419SSDQ&quot;,</span><br><span class=\"line\">      &quot;transport_address&quot; : &quot;127.0.0.1:9300&quot;,</span><br><span class=\"line\">      &quot;host&quot; : &quot;127.0.0.1&quot;,</span><br><span class=\"line\">      &quot;ip&quot; : &quot;127.0.0.1&quot;,</span><br><span class=\"line\">      &quot;version&quot; : &quot;7.15.2&quot;,</span><br><span class=\"line\">      &quot;build_flavor&quot; : &quot;default&quot;,</span><br><span class=\"line\">      &quot;build_type&quot; : &quot;zip&quot;,</span><br><span class=\"line\">      &quot;build_hash&quot; : &quot;93d5a7f6192e8a1a12e154a2b81bf6fa7309da0c&quot;,</span><br><span class=\"line\">      &quot;total_indexing_buffer&quot; : 103795916,</span><br><span class=\"line\">      &quot;roles&quot; : [</span><br><span class=\"line\">        &quot;data&quot;,</span><br><span class=\"line\">        &quot;data_cold&quot;,</span><br><span class=\"line\">        &quot;data_content&quot;,</span><br><span class=\"line\">        &quot;data_frozen&quot;,</span><br><span class=\"line\">        &quot;data_hot&quot;,</span><br><span class=\"line\">        &quot;data_warm&quot;,</span><br><span class=\"line\">        &quot;ingest&quot;,</span><br><span class=\"line\">        &quot;master&quot;,</span><br><span class=\"line\">        &quot;ml&quot;,</span><br><span class=\"line\">        &quot;remote_cluster_client&quot;,</span><br><span class=\"line\">        &quot;transform&quot;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"12-检索当前-hot-thread-的节点信息\"><a class=\"markdownIt-Anchor\" href=\"#12-检索当前-hot-thread-的节点信息\">#</a> 1.2、检索当前 hot thread 的节点信息</h4>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">GET</span> /_nodes/hot_threads</span><br></pre></td></tr></table></figure>\n<h3 id=\"2-索引index\"><a class=\"markdownIt-Anchor\" href=\"#2-索引index\">#</a> 2. 索引（index）</h3>\n<h4 id=\"21-创建索引\"><a class=\"markdownIt-Anchor\" href=\"#21-创建索引\">#</a> 2.1、创建索引</h4>\n<blockquote>\n<p>使用 PUT 方式或者 POST 添加（索引不存在会自动创建索引）</p>\n</blockquote>\n<ul>\n<li><code>settting</code> ：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L21hcHBpbmctc2V0dGluZ3MtbGltaXQuaHRtbA==\">index 的配置项</span></li>\n<li><code>mappings</code> ：设置文档的字段类型</li>\n<li><code>aliases</code> ：为索引添加别名</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">PUT</span> &#123;index&#125;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;index&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;number_of_shards&quot;</span>: <span class=\"number\">3</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;number_of_replicas&quot;</span>: <span class=\"number\">2</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;_doc&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;properties&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field1&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;aliases&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;alias_1&quot;</span>: &#123;&#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;alias_2&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;filter&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;term&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;user&quot;</span>: <span class=\"string\">&quot;kimchy&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;routing&quot;</span>: <span class=\"string\">&quot;kimchy&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"22-dynamic-mapping\"><a class=\"markdownIt-Anchor\" href=\"#22-dynamic-mapping\">#</a> 2.2、Dynamic Mapping</h4>\n<blockquote>\n<p>对于文档中未定义的字段，可以通过动态映射来定义是否动态添加。</p>\n</blockquote>\n<p>类型通过字段的值动态推算，需要注意的几个：</p>\n<table>\n<thead>\n<tr>\n<th><code>JSON DataType</code></th>\n<th><code>Elasticsearch datatype</code></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>integer</td>\n<td>long</td>\n</tr>\n<tr>\n<td>array</td>\n<td>第一个非空的 value 的类型数组</td>\n</tr>\n<tr>\n<td>string</td>\n<td>text</td>\n</tr>\n<tr>\n<td>浮点数</td>\n<td>float</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><code>dynamic</code> ：是否开启 动态 Mapping（false、true、7 + 版本添加 runtime）</li>\n<li><code>date_detection</code> ：是否开启 date 类型转换</li>\n<li><code>dynamic_date_formats</code> ：动态将字符串转为 date 类型，这样只有这种格式会转换为 date 类型</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">PUT</span> my_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;_doc&quot;</span>: &#123;</span><br><span class=\"line\">\t  <span class=\"string\">&quot;dynamic&quot;</span>: <span class=\"literal\">true</span>\t\t</span><br><span class=\"line\">      <span class=\"string\">&quot;date_detection&quot;</span>: <span class=\"literal\">true</span>\t\t\t\t</span><br><span class=\"line\">      <span class=\"string\">&quot;dynamic_date_formats&quot;</span>: [<span class=\"string\">&quot;MM/dd/yyyy&quot;</span>]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"runtime-fields-和-script-fields\"><a class=\"markdownIt-Anchor\" href=\"#runtime-fields-和-script-fields\">#</a> Runtime Fields 和 Script Fields</h4>\n<ul>\n<li>\n<p>Runtime Fields：运行时字段，可以用于聚合、排序等操作，查询时效率会略微降低（字段值运行时计算），减少磁盘的存储（不被存储和索引）。</p>\n<p>试用场景：日志</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">PUT</span> students/_mapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;runtime&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;score_flag&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;keyword&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;script&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;source&quot;</span>: <span class=\"string\">&quot;if (doc[&#x27;score&#x27;].value &gt; 90) emit(&#x27;A&#x27;); else if(doc[&#x27;score&#x27;].value &gt; 75) emit(&#x27;B&#x27;); else if(doc[&#x27;score&#x27;].value &gt; 60) return emit(&#x27;C&#x27;); else emit(&#x27;D&#x27;);&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable constant_\">GET</span> students/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 不设置该属性查询时不会显示运行时字段</span></span><br><span class=\"line\">  <span class=\"string\">&quot;fields&quot;</span> : [<span class=\"string\">&quot;*&quot;</span>],</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li>\n<p>Script Fields：脚本字段，不可用于聚合等操作，数据查询时进行操作。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">POST</span> students/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;script_fields&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;score_flag&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;script&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;lang&quot;</span>: <span class=\"string\">&quot;painless&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;source&quot;</span>: <span class=\"string\">&quot;if (doc[&#x27;score&#x27;].value &gt; 90) return &#x27;A&#x27;; else if(doc[&#x27;score&#x27;].value &gt; 75) return &#x27;B&#x27;; else if(doc[&#x27;score&#x27;].value &gt; 60) return &#x27;C&#x27;; else return &#x27;D&#x27;;&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h4 id=\"23-查询索引\"><a class=\"markdownIt-Anchor\" href=\"#23-查询索引\">#</a> 2.3、查询索引</h4>\n<h5 id=\"查询索引是否存在\"><a class=\"markdownIt-Anchor\" href=\"#查询索引是否存在\">#</a> 查询索引是否存在</h5>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">head /customer</span><br></pre></td></tr></table></figure>\n<h5 id=\"表格形式返回索引信息\"><a class=\"markdownIt-Anchor\" href=\"#表格形式返回索引信息\">#</a> 表格形式返回索引信息</h5>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">GET</span> /_cat/indices</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">response</span>:</span><br><span class=\"line\">healthy status index\t\t\t\t\t\t   uuid\t\t\t\t\t  pri rep docs.<span class=\"property\">count</span> docs.<span class=\"property\">deleted</span> store.<span class=\"property\">size</span> pri.<span class=\"property\">store</span>.<span class=\"property\">size</span></span><br><span class=\"line\">green   open   .<span class=\"property\">geoip_databases</span>                F0S_AfxbS4qnRfmUZYGyBg <span class=\"number\">1</span>   <span class=\"number\">0</span>   <span class=\"number\">42</span>         <span class=\"number\">39</span>           <span class=\"number\">40.</span>6mb     <span class=\"number\">40.</span>6mb</span><br><span class=\"line\">yellow open    my_index_01                     <span class=\"title class_\">HU0</span>-D83QQMasMtdlfPIUAw <span class=\"number\">1</span>   <span class=\"number\">1</span>   <span class=\"number\">0</span>          <span class=\"number\">0</span>            230b       230b</span><br><span class=\"line\">yellow open  chapter                         nouKVwjsToaPqQR4QS4D-w <span class=\"number\">1</span> <span class=\"number\">1</span>  <span class=\"number\">3</span>     <span class=\"number\">0</span>  <span class=\"number\">8.</span>7kb  <span class=\"number\">8.</span>7kb</span><br><span class=\"line\">yellow close my_index_02                     to-6fbc0QsyMsBuwyOELKA <span class=\"number\">1</span> <span class=\"number\">1</span>                       </span><br><span class=\"line\">green  open  .<span class=\"property\">apm</span>-custom-link                zCu-<span class=\"title class_\">FR7</span>oR3CLVvdEp-<span class=\"variable constant_\">JSRQ</span> <span class=\"number\">1</span> <span class=\"number\">0</span>  <span class=\"number\">0</span>     <span class=\"number\">0</span>   208b   208b</span><br><span class=\"line\">yellow open  schools                         8YMa4HV0T1CxvZSVcEVoWw <span class=\"number\">1</span> <span class=\"number\">1</span>  <span class=\"number\">1</span>     <span class=\"number\">0</span>  <span class=\"number\">4.</span>6kb  <span class=\"number\">4.</span>6kb</span><br><span class=\"line\">green  open  .<span class=\"property\">kibana</span>-event-log-<span class=\"number\">7.15</span><span class=\"number\">.2</span>-<span class=\"number\">000001</span> <span class=\"title class_\">WloRRcBOSfOmeS</span>-<span class=\"title class_\">Sc8N3</span>vw <span class=\"number\">1</span> <span class=\"number\">0</span>  <span class=\"number\">2</span>     <span class=\"number\">0</span> <span class=\"number\">11.</span>9kb <span class=\"number\">11.</span>9kb</span><br><span class=\"line\">green  open  .<span class=\"property\">apm</span>-agent-configuration        Y9bRJgbiR06TwsQzCQqG4g <span class=\"number\">1</span> <span class=\"number\">0</span>  <span class=\"number\">0</span>     <span class=\"number\">0</span>   208b   208b</span><br><span class=\"line\">green  open  .<span class=\"property\">kibana_pre6</span><span class=\"number\">.5</span><span class=\"number\">.0_001</span>            L8NwjI1bSPGfA7XfPVWGgA <span class=\"number\">1</span> <span class=\"number\">0</span>  <span class=\"number\">1</span>     <span class=\"number\">0</span>  <span class=\"number\">5.</span>5kb  <span class=\"number\">5.</span>5kb</span><br><span class=\"line\">green  open  .<span class=\"property\">kibana_7</span><span class=\"number\">.15</span><span class=\"number\">.2_001</span>              7nAFYuyRSa6Tj5tGbM85bg <span class=\"number\">1</span> <span class=\"number\">0</span> <span class=\"number\">47</span>    <span class=\"number\">16</span>  <span class=\"number\">2.</span>3mb  <span class=\"number\">2.</span>3mb</span><br><span class=\"line\">green  open  .<span class=\"property\">tasks</span>                          1zbUv88mTim-<span class=\"number\">0</span>--gLetpTQ <span class=\"number\">1</span> <span class=\"number\">0</span>  <span class=\"number\">4</span>     <span class=\"number\">0</span> <span class=\"number\">27.</span>2kb <span class=\"number\">27.</span>2kb</span><br><span class=\"line\">green  open  .<span class=\"property\">kibana_task_manager_7</span><span class=\"number\">.15</span><span class=\"number\">.2_001</span> <span class=\"title class_\">Adr8ANIjRiWtSbFVo2PGGg</span> <span class=\"number\">1</span> <span class=\"number\">0</span> <span class=\"number\">15</span> <span class=\"number\">11785</span>  <span class=\"number\">1.</span>5mb  <span class=\"number\">1.</span>5mb</span><br></pre></td></tr></table></figure>\n<h4 id=\"24-打开和关闭索引\"><a class=\"markdownIt-Anchor\" href=\"#24-打开和关闭索引\">#</a> 2.4、打开和关闭索引</h4>\n<ul>\n<li>关闭索引：只显示元数据，不能够读写数据</li>\n<li>打开索引：允许读写（正常操作）</li>\n</ul>\n<h4 id=\"25-索引生命周期和滚动索引rollover\"><a class=\"markdownIt-Anchor\" href=\"#25-索引生命周期和滚动索引rollover\">#</a> 2.5、索引生命周期和滚动索引（rollover）</h4>\n<blockquote>\n<p>滚动索引是  <code>5.X</code>  之后推出的 API，解决以日期作为索引名称大小不均匀的问题</p>\n</blockquote>\n<p>索引的生命周期（ILM）和 冷热架构</p>\n<ul>\n<li>热接点（Hot）：用户最关心的热数据</li>\n<li>温节点（Warm）：存放前一段时间沉淀的热数据</li>\n<li>冷接点（Cold）：用户不太关心的数据，或者很久前的数据</li>\n<li><code>frozen</code></li>\n<li><code>delete</code></li>\n</ul>\n<p>磁盘数据不足时优先删除冷接点数据，硬件资源不足时，热接点优先使用 SSD</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">PUT</span> my-index-<span class=\"number\">2021.12</span><span class=\"number\">.27</span>-<span class=\"number\">000001</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;aliases&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;my-alias&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;is_write_index&quot;</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable constant_\">POST</span> my-alias/_rollover</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;conditions&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;max_age&quot;</span>: <span class=\"string\">&quot;7d&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_docs&quot;</span>: <span class=\"number\">100</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_size&quot;</span>: <span class=\"string\">&quot;5gb&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>需要注意配置索引的别名时，必须配置  <code>is_write_index:true</code> ，rollover 只能用于  <code>alias</code>  和  <code>data stream</code>  ，索引名也需要设置为  <code>*-00001</code>  类似的格式，这样 rollover 的时候索引名可以累加，否则会报错。</p>\n<p>上述配置中，当索引满足任意一个条件都会生成新的索引（时间间隔超过 7 天 或 最大文档超过 100 个 或 文档总大小超过 5GB）</p>\n<h4 id=\"26-冻结或解除索引freeze\"><a class=\"markdownIt-Anchor\" href=\"#26-冻结或解除索引freeze\">#</a> 2.6、冻结或解除索引（freeze）</h4>\n<blockquote>\n<p>冻结索引后，当前索引不占用内存空间，只占用磁盘。索引可以被查询（效率较低），通常使用在快速缓解集群内存使用率过高的情况导致的熔断上。</p>\n</blockquote>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">POST</span> &#123;index_name&#125;/_freeze</span><br><span class=\"line\"><span class=\"variable constant_\">POST</span> &#123;index_name&#125;/_unfreeze</span><br></pre></td></tr></table></figure>\n<h4 id=\"27-重构索引reindex\"><a class=\"markdownIt-Anchor\" href=\"#27-重构索引reindex\">#</a> 2.7、重构索引（ <code>reindex</code> ）</h4>\n<blockquote>\n<p>常用在字段类型变更、分片数量变更、迁移索引等场景。 <code>reindex</code>  执行过程中<strong>索引需要停止写入</strong>，否则会出现数据不一致的问题，如果索引数据量较大，需要添加  <code>wait_for_completion=false</code> ，这样调用 <code>Reindex API</code>  时就异步执行并返回一个  <code>taskId</code>  。我们可以通过该  <code>taskId</code>  来查看  <code>reindex</code>  状态甚至取消该 task</p>\n</blockquote>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">POST</span> _reindex</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;source&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;index&quot;</span>: <span class=\"string\">&quot;&#123;source_index_name&#125;&quot;</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;dest&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;index&quot;</span>: <span class=\"string\">&quot;&#123;dest_index_name&#125;&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-文档doc\"><a class=\"markdownIt-Anchor\" href=\"#3-文档doc\">#</a> 3. 文档（doc）</h3>\n<h4 id=\"31-创建和修改文档\"><a class=\"markdownIt-Anchor\" href=\"#31-创建和修改文档\">#</a> 3.1、创建和修改文档</h4>\n<h5 id=\"311创建修改单个文档通过id查找\"><a class=\"markdownIt-Anchor\" href=\"#311创建修改单个文档通过id查找\">#</a> 3.1.1）创建修改单个文档（通过 id 查找）</h5>\n<blockquote>\n<p>使用 POST 和 PUT 的方式添加或者修改文档，与 POST 的 _update 不同的是，如果文档已经存在，覆盖文档，而不会修改文档对应的字段</p>\n</blockquote>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">POST</span> &#123;index&#125;/_doc/&#123;id&#125;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable constant_\">PUT</span> &#123;index&#125;/_doc/&#123;id&#125;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"312query形式修改文档\"><a class=\"markdownIt-Anchor\" href=\"#312query形式修改文档\">#</a> 3.1.2）query 形式修改文档</h5>\n<p>待补充</p>\n<h5 id=\"313批量操作文档_bulk\"><a class=\"markdownIt-Anchor\" href=\"#313批量操作文档_bulk\">#</a> 3.1.3）批量操作文档（_bulk）</h5>\n<blockquote>\n<p>支持批量覆盖、删除、添加和部分字段修改</p>\n</blockquote>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">POST</span> &#123;index&#125;/_bulk?refresh</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;index&quot;</span>:&#123;<span class=\"string\">&quot;_id&quot;</span>:<span class=\"string\">&quot;1&quot;</span>&#125;&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;field&quot;</span>:<span class=\"string\">&quot;TEXT&quot;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;delete&quot;</span>:&#123;<span class=\"string\">&quot;_id&quot;</span>:<span class=\"string\">&quot;2&quot;</span>&#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;create&quot;</span>:&#123;<span class=\"string\">&quot;_id&quot;</span>:<span class=\"string\">&quot;3&quot;</span>&#125;&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;field&quot;</span>:<span class=\"string\">&quot;value&quot;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;update&quot;</span>:&#123;<span class=\"string\">&quot;_id&quot;</span>:<span class=\"string\">&quot;1&quot;</span>&#125;&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">&quot;doc&quot;</span>:&#123;<span class=\"string\">&quot;field&quot;</span>:<span class=\"string\">&quot;value&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"32-搜索文档\"><a class=\"markdownIt-Anchor\" href=\"#32-搜索文档\">#</a> 3.2、搜索文档</h4>\n<h5 id=\"321_search-搜索\"><a class=\"markdownIt-Anchor\" href=\"#321_search-搜索\">#</a> 3.2.1） <code>_search</code>  搜索</h5>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">GET</span> &#123;index&#125;/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;match&quot;</span>: &#123;<span class=\"string\">&quot;address&quot;</span>:<span class=\"string\">&quot;mill lane&quot;</span>&#125;\t<span class=\"comment\">// 匹配到mill或者lane</span></span><br><span class=\"line\">      <span class=\"string\">&quot;match_phrase&quot;</span>: &#123;<span class=\"string\">&quot;address&quot;</span>: <span class=\"string\">&quot;mill lane&quot;</span>&#125;\t<span class=\"comment\">// 匹配到mill lane这条语句</span></span><br><span class=\"line\">      <span class=\"string\">&quot;bool&quot;</span>: &#123;<span class=\"string\">&quot;must&quot;</span>:[], <span class=\"string\">&quot;must_not&quot;</span>:[], <span class=\"string\">&quot;should&quot;</span>:[]&#125;</span><br><span class=\"line\">  &#125;,\t<span class=\"comment\">// 查询，类似where</span></span><br><span class=\"line\">  <span class=\"string\">&quot;sort&quot;</span>: [],\t<span class=\"comment\">// 排序</span></span><br><span class=\"line\">  <span class=\"string\">&quot;from&quot;</span>: <span class=\"number\">0</span>,\t<span class=\"comment\">// 分页</span></span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: <span class=\"number\">20</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">response：</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;took&quot;</span> : <span class=\"number\">3</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;timed_out&quot;</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;_shards&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span> : <span class=\"number\">5</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;successful&quot;</span> : <span class=\"number\">5</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;skipped&quot;</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;failed&quot;</span> : <span class=\"number\">0</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;hits&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;total&quot;</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;max_score&quot;</span> : <span class=\"number\">1.0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;hits&quot;</span> : [</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;_index&quot;</span> : <span class=\"string\">&quot;customer&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;_type&quot;</span> : <span class=\"string\">&quot;_doc&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;_id&quot;</span> : <span class=\"string\">&quot;1&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;_score&quot;</span> : <span class=\"number\">1.0</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;_source&quot;</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;name&quot;</span> : <span class=\"string\">&quot;zcx&quot;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;sno&quot;</span> : <span class=\"string\">&quot;31701028&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 精准查询schools索引中，username=zcx的数据</span></span><br><span class=\"line\"><span class=\"variable constant_\">GET</span> schools/_search?q=<span class=\"attr\">username</span>:zcx</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>took</code> ：执行时间（毫秒）</li>\n<li><code>time_out</code> ：请求是否超时</li>\n<li><code>_shards</code> ：分片总数、成功、失败、跳过</li>\n<li><code>max_score</code> ：最相关文档的总数</li>\n<li><code>hits</code> ：命中</li>\n</ul>\n<p><strong>query</strong></p>\n<ul>\n<li>\n<p><code>wildcard query</code> （查询速度可能会较慢，尽量防止通配符出现在开头位置）</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;wildcard&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;test*&quot;</span></span><br><span class=\"line\">        &#125; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>通配符 * ：类似 MySQL【 <code>where field like 'test%'</code> 】</li>\n<li>通配符？：类似 MySQL【 <code>where field like 'test_'</code> 】</li>\n</ul>\n</li>\n<li>\n<p><code>prefix query</code></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;prefix&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;test&quot;</span></span><br><span class=\"line\">        &#125; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>等价于  <code>&quot;wildcard&quot;: &#123;&quot;name&quot;: &quot;test*&quot;&#125;</code></p>\n</li>\n<li>\n<p><code>fuzzy query</code></p>\n<p>模糊查询使用基于 Levenshtein 编辑距离的相似度，用于查询误拼写的 fuzzy 模糊搜索技术。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;fuzzy&quot;</span> : &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;name&quot;</span>: &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;value&quot;</span>: <span class=\"string\">&quot;test&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;fuzziness&quot;</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;prefix_length&quot;</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;max_expansions&quot;</span>: <span class=\"number\">100</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>fuzziness：最大编辑距离【一个字符串变成另一个字符串的需要操作的步数】。默认为 AUTO</li>\n<li>prefix_length：不会被初始化的字符串。默认为 0</li>\n<li>max_expansions：控制与前缀匹配的词的数量。默认为 50</li>\n<li>transpositions：是否支持模糊转置（ab → ba）。默认为 false</li>\n</ul>\n</li>\n<li>\n<p><code>boolean query</code></p>\n<ul>\n<li><code>must</code> ：查询条件必须出现在文档中，并计算分数。使用  <code>match_all</code>  返回全部，score 全部为 1.0</li>\n<li><code>filter</code> ：与 must 类似。但不计算分数，同时 filter 的计算结果可以缓存</li>\n<li><code>should</code> ：查询条件应该出现在文档，并计算分数。通过  <code>minimum_should_match </code>  设置满足 should 几个条件，当设置为 0 时，可以不满足任何 should 也可以被查询</li>\n<li><code>must_not</code> ：查询条件必须不出现在文档，不会计算分数，结果可以被缓存</li>\n</ul>\n</li>\n<li>\n<p><code>boosting query</code></p>\n</li>\n<li></li>\n</ul>\n<h5 id=\"322获取索引相关的统计数据\"><a class=\"markdownIt-Anchor\" href=\"#322获取索引相关的统计数据\">#</a> 3.2.2）获取索引相关的统计数据</h5>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">GET</span> /school/_stats</span><br></pre></td></tr></table></figure>\n<h5 id=\"323分页搜索\"><a class=\"markdownIt-Anchor\" href=\"#323分页搜索\">#</a> 3.2.3）分页搜索</h5>\n<ul>\n<li>\n<p><strong>From + Size 查询</strong></p>\n<ul>\n<li>from：未指定，<strong>默认为 0</strong>，指第一个数据的 index（与传统的第几页不同）</li>\n<li>size：未指定，默认为 10</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">GET</span> students/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;from&quot;</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: <span class=\"number\">2</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>优点：支持随机翻页</p>\n<p>缺点：</p>\n<ul>\n<li>受制于  <code>max_result_window</code>  的设置（from + size &lt; max_result_window），不能无限翻页，默认为 10000。</li>\n<li>存在深度翻页的问题（from 前面的数据也会查出），越往后翻页越慢。</li>\n</ul>\n<p>搜素一般会跨越分片进行搜索，每个分片必须将其请求的命中内容以及任何先前页面的命中内容加载到内存（将 from + size 的文档加载到内存）。大量消耗内存和 CPU 使用率。</p>\n</li>\n<li>\n<p><strong>search_after 查询（推荐使用）</strong></p>\n<blockquote>\n<p>使用前一页的一组排序来检索下一页的排序</p>\n</blockquote>\n<p>前置条件：使用 search_after 要求后续的多个请求返回与第一次查询相同的排序结果序列。也就是说，即便在后续翻页的过程中，可能会有新数据写入等操作，但这些操作不会对原有结果集构成影响。</p>\n<p>实现：创建一个 Point in Time（PIT，类似快照的方式，在 7.10 之后才有的新特性）</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">POST</span> students/_pit?keep_alive=1m</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">POST</span> _search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;track_total_hits&quot;</span>: <span class=\"literal\">true</span>, </span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">   <span class=\"string\">&quot;pit&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;id&quot;</span>: <span class=\"string\">&quot;xxx&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>keep_alive 过期是报错而不是重新创建新的 PIT？</p>\n<p>返回的 sort，第一个字段表示排序方式，以某个字段升序或者降序排序的意思；第二个字段为 tiebreaker（参考官方文档）</p>\n<p>缺点：只支持向后翻页</p>\n</li>\n<li>\n<p><strong>scroll</strong></p>\n<blockquote>\n<p>适用于遍历查询，搜索大量结果甚至于所有结果</p>\n</blockquote>\n<p>搜索时创建一个快照</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">POST</span> students/_search?scroll=3m</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: <span class=\"number\">100</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable constant_\">POST</span> _search/scroll                                   </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;scroll&quot;</span> : <span class=\"string\">&quot;3m&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;scroll_id&quot;</span>:<span class=\"string\">&quot;xxx&quot;</span> </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>非实时的响应，同时快照需要消耗大量堆内存</p>\n</li>\n</ul>\n<h4 id=\"33-聚合分析\"><a class=\"markdownIt-Anchor\" href=\"#33-聚合分析\">#</a> 3.3、聚合分析</h4>\n<blockquote>\n<p>底层使用倒排索引 + 正排索引（参考四 - 2 和 3）</p>\n</blockquote>\n<p>aggs → name（自定义）→ type（histogram、terms 等）→ 聚合字典、其他信息</p>\n<h5 id=\"331bucket-aggregations桶聚合\"><a class=\"markdownIt-Anchor\" href=\"#331bucket-aggregations桶聚合\">#</a> 3.3.1）bucket aggregations（桶聚合）</h5>\n<h5 id=\"332histogram-aggregations直方图统计\"><a class=\"markdownIt-Anchor\" href=\"#332histogram-aggregations直方图统计\">#</a> 3.3.2）histogram aggregations（直方图统计）</h5>\n<blockquote>\n<p>根据指定的间隔构造存储桶。值应该放入哪个桶？向下舍入最接近的间隔存储桶</p>\n<p>bucket_key = Math.floor((value - offset) / interval) * interval + offset</p>\n</blockquote>\n<p><strong>时间间隔必须为正十进制数，而偏移量必须为 [0，offset] 范围内的十进制</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">POST</span> students/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;score_histogram&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;histogram&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;score&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;interval&quot;</span>: <span class=\"number\">20</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">response</span>:</span><br><span class=\"line\"><span class=\"string\">&quot;aggregations&quot;</span> : &#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;score_histogram&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;buckets&quot;</span> : [</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;key&quot;</span> : <span class=\"number\">40.0</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;doc_count&quot;</span> : <span class=\"number\">1</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;key&quot;</span> : <span class=\"number\">60.0</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;doc_count&quot;</span> : <span class=\"number\">2</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;key&quot;</span> : <span class=\"number\">80.0</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;doc_count&quot;</span> : <span class=\"number\">2</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"333terms-aggregations术语聚合\"><a class=\"markdownIt-Anchor\" href=\"#333terms-aggregations术语聚合\">#</a> 3.3.3）Terms aggregations（术语聚合）</h5>\n<blockquote>\n<p>搜索指定字段的唯一值构建存储桶。</p>\n</blockquote>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">GET</span> students/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;size&quot;</span>: <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;aggs&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;names&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;terms&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;field&quot;</span>: <span class=\"string\">&quot;score&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;size&quot;</span>: <span class=\"number\">10</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"34-数据类型datatype\"><a class=\"markdownIt-Anchor\" href=\"#34-数据类型datatype\">#</a> 3.4、数据类型（dataType）</h4>\n<h5 id=\"341nested-datatype-object-datatype\"><a class=\"markdownIt-Anchor\" href=\"#341nested-datatype-object-datatype\">#</a> 3.4.1）Nested dataType &amp; Object dataType</h5>\n<blockquote>\n<p>arrays of objects can be indexed</p>\n</blockquote>\n<p>主要用于查询某个对象或者对象数组字段下的某个字段值</p>\n<p><em>username 使用 Object dataType，cources 使用 nested dataType</em></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">PUT</span> students2000</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;properties&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;username&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;properties&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;first&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          <span class=\"string\">&quot;last&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;text&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;cources&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;nested&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>查询</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">GET</span> students2000/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;nested&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;path&quot;</span>: <span class=\"string\">&quot;cources&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;query&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;bool&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;must&quot;</span>: [</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;match&quot;</span>: &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;cources.name&quot;</span>: <span class=\"string\">&quot;chinese&quot;</span></span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"4-模板template\"><a class=\"markdownIt-Anchor\" href=\"#4-模板template\">#</a> 4. 模板（template）</h3>\n<h4 id=\"41-dynamic-template\"><a class=\"markdownIt-Anchor\" href=\"#41-dynamic-template\">#</a> 4.1、Dynamic template</h4>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">PUT</span> my_index</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;mappings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;_doc&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;dynamic_templates&quot;</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;integers&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;match_mapping_type&quot;</span>: <span class=\"string\">&quot;long&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;mapping&quot;</span>: &#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;integer&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;longs_as_strings&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;match_mapping_type&quot;</span>: <span class=\"string\">&quot;string&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;match&quot;</span>:   <span class=\"string\">&quot;long_*&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;unmatch&quot;</span>: <span class=\"string\">&quot;*_text&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;mapping&quot;</span>: &#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;long&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;longs_as_pattern_strings&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;match_mapping_type&quot;</span>: <span class=\"string\">&quot;string&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;match_pattern&quot;</span>: <span class=\"string\">&quot;regex&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;match&quot;</span>: <span class=\"string\">&quot;^profit_\\\\d+$&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;mapping&quot;</span>: &#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;long&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"5-管道pipeline\"><a class=\"markdownIt-Anchor\" href=\"#5-管道pipeline\">#</a> 5、管道（pipeline）</h3>\n<h3 id=\"6-别名alias\"><a class=\"markdownIt-Anchor\" href=\"#6-别名alias\">#</a> 6、别名（Alias）</h3>\n<blockquote>\n<p>一个索引是一组数据流或者 index 的别名，可以在任何时刻替换数据流或 index</p>\n</blockquote>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">POST</span> _aliases</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;actions&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;add&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;index&quot;</span>: <span class=\"string\">&quot;students2020&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;alias&quot;</span>: <span class=\"string\">&quot;students&quot;</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;remove&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;index&quot;</span>: <span class=\"string\">&quot;students2020&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;alias&quot;</span>: <span class=\"string\">&quot;students&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"7-缓存cache\"><a class=\"markdownIt-Anchor\" href=\"#7-缓存cache\">#</a> 7、缓存（Cache）</h3>\n<h4 id=\"71-api\"><a class=\"markdownIt-Anchor\" href=\"#71-api\">#</a> 7.1、API</h4>\n<h5 id=\"711清除缓存\"><a class=\"markdownIt-Anchor\" href=\"#711清除缓存\">#</a> 7.1.1）清除缓存</h5>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">POST</span> /_cache/clear</span><br><span class=\"line\"><span class=\"variable constant_\">POST</span> /&#123;index&#125;/_cache/clear</span><br><span class=\"line\"><span class=\"comment\">// 清理节点查询缓存</span></span><br><span class=\"line\"><span class=\"variable constant_\">POST</span> /&#123;index&#125;/_cache/clear?query=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\">// 清理reques缓存</span></span><br><span class=\"line\"><span class=\"variable constant_\">POST</span> /&#123;index&#125;/_cache/clear?request=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\">// 清理field data缓存</span></span><br><span class=\"line\"><span class=\"variable constant_\">POST</span> /&#123;index&#125;/_cache/clear?fielddata=<span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<p><strong>缓存应用场景</strong></p>\n<table>\n<thead>\n<tr>\n<th>缓存类型</th>\n<th>缓存内容</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>节点请求缓存</td>\n<td>缓存可维护在 filter 上下文中使用的查询结果。</td>\n</tr>\n<tr>\n<td>分片请求缓存</td>\n<td>缓存 size = 0 时频繁使用的查询的结果，尤其是聚合的结果。</td>\n</tr>\n<tr>\n<td>字段请求缓存 （Field data）</td>\n<td>用于排序和支持某些字段类型上的聚合。</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"712禁用或启用缓存\"><a class=\"markdownIt-Anchor\" href=\"#712禁用或启用缓存\">#</a> 7.1.2）禁用或启用缓存</h5>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">PUT</span> &#123;index&#125;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;settings&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;index.requests.cache.enable&quot;</span>: <span class=\"literal\">false</span></span><br><span class=\"line\">  &#125;   </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"713全局查询缓存\"><a class=\"markdownIt-Anchor\" href=\"#713全局查询缓存\">#</a> 7.1.3）全局查询缓存</h5>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">GET</span> _cat/nodes?v&amp;h=id,queryCacheMemory,queryCacheEvictions,requestCacheMemory,requestCacheHitCount,requestCacheMissCount,flushTotal,flushTotalTime</span><br></pre></td></tr></table></figure>\n<h4 id=\"72-节点查询缓存\"><a class=\"markdownIt-Anchor\" href=\"#72-节点查询缓存\">#</a> 7.2、节点查询缓存</h4>\n<blockquote>\n<p><code>Filter</code>  或者  <code>Term</code>  查询的结果进行缓存，节点的所有分片共享，使用  <code>LRU</code>  策略</p>\n</blockquote>\n<p>默认情况下，节点查询缓存最多容纳 10000 个查询，占总堆空间的 10%</p>\n<h3 id=\"8-text-analysis\"><a class=\"markdownIt-Anchor\" href=\"#8-text-analysis\">#</a> 8、Text analysis</h3>\n<h4 id=\"81-概念concept\"><a class=\"markdownIt-Anchor\" href=\"#81-概念concept\">#</a> 8.1、概念（concept）</h4>\n<h5 id=\"81-词干stemmer\"><a class=\"markdownIt-Anchor\" href=\"#81-词干stemmer\">#</a> 8.1、词干（Stemmer）</h5>\n<p>查询时词干分析将单词还原为词根，两个具有相同词根的不同单词可以搜索出来（例： <code>working</code>  和  <code>worked</code> ）</p>\n<p><code>stemmer token filters</code></p>\n<h5 id=\"82-token-graph\"><a class=\"markdownIt-Anchor\" href=\"#82-token-graph\">#</a> 8.2、token graph</h5>\n<ul>\n<li>position：每个词（token）的位置</li>\n<li>position length：词（token）跨域的间距</li>\n</ul>\n<p>相似语句【synonyms】（例：fast car 和 quick car）</p>\n<p><code>Multi-position tokens</code> （例：简称，domain name system 和 dns）</p>\n<h4 id=\"tokenization\"><a class=\"markdownIt-Anchor\" href=\"#tokenization\">#</a> Tokenization</h4>\n<p>将一个 text 拆分成更小的块。大部分情况下这些 token 都是一个独立的单词。</p>\n<p>text： <code>the quick brown fox jumps</code> ，查询语句  <code>quick fox</code></p>\n<p>匹配查询中独立的一些词</p>\n<h4 id=\"normalization\"><a class=\"markdownIt-Anchor\" href=\"#normalization\">#</a> Normalization</h4>\n<p>匹配近似语义的词</p>\n<ul>\n<li>大小写：big、Big</li>\n<li>前后缀</li>\n</ul>\n<h2 id=\"四-底层原理\"><a class=\"markdownIt-Anchor\" href=\"#四-底层原理\">#</a> 四、底层原理</h2>\n<h3 id=\"1-文档的创建\"><a class=\"markdownIt-Anchor\" href=\"#1-文档的创建\">#</a> 1、<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9jbi9lbGFzdGljc2VhcmNoL2d1aWRlL2N1cnJlbnQvdHJhbnNsb2cuaHRtbA==\">文档的创建</span></h3>\n<ul>\n<li>doc 写入到 in-memory buffer，同时将操作写入到 Translog（应该是在硬盘，防止系统中断等操作导致内存丢失，通过 Translog 复原数据）</li>\n<li>每隔一秒执行 refresh 操作：将 in-memory buffer 的数据写入到 segment（内存，查询时轮询分片的所有 segment，segment 太多会导致查询效率降低，es 会自动合并 segment 到一个大的 segment，等到大的 segment 被写入磁盘，删除所有小的 segment）</li>\n<li>每隔 30 分钟执行一次 fresh 操作（或者 Translog 太大）：将 segment 的数据存入到磁盘</li>\n</ul>\n<p><code>Translog</code> ：默认 5 秒加载被  <code>fsync</code>  加载到硬盘，或者每次写请求完成后也会执行（index、update、bulk 等）。这个过程在主分片和副本分片都会发生，因此需要等到所有操作都执行完成后才会执行  <code>200 OK</code>  的响应</p>\n<p><img data-src=\"image-20220315162821232.png\" alt=\"image-20220315162859107\"></p>\n<h3 id=\"2-倒排索引\"><a class=\"markdownIt-Anchor\" href=\"#2-倒排索引\">#</a> 2、倒排索引</h3>\n<h3 id=\"3-正排索引\"><a class=\"markdownIt-Anchor\" href=\"#3-正排索引\">#</a> 3、正排索引</h3>\n<h3 id=\"4-lucene文件与数据压缩\"><a class=\"markdownIt-Anchor\" href=\"#4-lucene文件与数据压缩\">#</a> 4、Lucene 文件与数据压缩</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Extension</th>\n<th>Brief Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Segment Info</td>\n<td>.si</td>\n<td>segment 的元数据文件</td>\n</tr>\n<tr>\n<td>Compound File</td>\n<td>.cfs, .cfe</td>\n<td>一个 segment 包含了如下表的各个文件，为减少打开文件的数量，在 segment 小的时候，segment 的所有文件内容都保存在 cfs 文件中，cfe 文件保存了 lucene 各文件在 cfs 文件的位置信息</td>\n</tr>\n<tr>\n<td>Fields</td>\n<td>.fnm</td>\n<td>保存了 fields 的相关信息</td>\n</tr>\n<tr>\n<td>Field Index</td>\n<td>.fdx</td>\n<td>正排存储文件的元数据信息</td>\n</tr>\n<tr>\n<td>Field Data</td>\n<td><strong>.fdt</strong></td>\n<td>存储了正排存储数据，写入的原文存储在这</td>\n</tr>\n<tr>\n<td>Term Dictionary</td>\n<td><strong>.tim</strong></td>\n<td>倒排索引的元数据信息</td>\n</tr>\n<tr>\n<td>Term Index</td>\n<td>.tip</td>\n<td>倒排索引文件，存储了所有的倒排索引数据</td>\n</tr>\n<tr>\n<td>Frequencies</td>\n<td>.doc</td>\n<td>保存了每个 term 的 doc id 列表和 term 在 doc 中的词频</td>\n</tr>\n<tr>\n<td>Positions</td>\n<td>.pos</td>\n<td>Stores position information about where a term occurs in the index 全文索引的字段，会有该文件，保存了 term 在 doc 中的位置</td>\n</tr>\n<tr>\n<td>Payloads</td>\n<td>.pay</td>\n<td>Stores additional per-position metadata information such as character offsets and user payloads 全文索引的字段，使用了一些像 payloads 的高级特性会有该文件，保存了 term 在 doc 中的一些高级特性</td>\n</tr>\n<tr>\n<td>Norms</td>\n<td>.nvd, .nvm</td>\n<td>文件保存索引字段加权数据</td>\n</tr>\n<tr>\n<td>Per-Document Values</td>\n<td><strong>.dvd, .dvm</strong></td>\n<td>lucene 的 docvalues 文件，即数据的列式存储，用作聚合和排序</td>\n</tr>\n<tr>\n<td>Term Vector Data</td>\n<td>.tvx, .tvd, .tvf</td>\n<td>Stores offset into the document data file 保存索引字段的矢量信息，用在对 term 进行高亮，计算文本相关性中使用</td>\n</tr>\n<tr>\n<td>Live Documents</td>\n<td>.liv</td>\n<td>记录了 segment 中删除的 doc</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"5-索引的压缩机制\"><a class=\"markdownIt-Anchor\" href=\"#5-索引的压缩机制\">#</a> 5、索引的压缩机制</h3>\n<ul>\n<li>\n<p>在倒排索引的基础上建立词典索引（term index）</p>\n<p>为什么需要词典索引？倒排索引创建好词典元素是排好序的，可以通过二分查找快速筛选；但是 ES 的索引是放在内存中的（为了提高效率），因此需要词典索引提交查询效率和压缩大小（主要目的）。</p>\n<p>词典索引使用 <strong>有限状态机</strong>。部分前缀使用有向图的方式。图不会包含所有的 term，只会包含 term 的前缀，通过前缀快速定位到指定的 block，block 中也只会存储去除前缀的部分，大大提高空间利用率。</p>\n</li>\n<li></li>\n</ul>\n<h3 id=\"6-计算文档相关性得分算法\"><a class=\"markdownIt-Anchor\" href=\"#6-计算文档相关性得分算法\">#</a> 6、计算文档相关性得分算法</h3>\n<blockquote>\n<p><code>TF-IDF</code>  算法（词频、逆文档频率）</p>\n</blockquote>\n<ul>\n<li>词频：所查找的单词在文档种出现的次数越多，得分越高。</li>\n<li>逆文档词频：如果某个单词在所有文档中比较少见，那么该词的权重越高，得分也越高。</li>\n</ul>\n<h2 id=\"五-elasticsearch-对比-solr\"><a class=\"markdownIt-Anchor\" href=\"#五-elasticsearch-对比-solr\">#</a> 五、elasticsearch 对比 solr</h2>\n<h3 id=\"configuration\"><a class=\"markdownIt-Anchor\" href=\"#configuration\">#</a> Configuration</h3>\n<ul>\n<li>es 所有配置保存在 <em>elasticsearch.yml</em>；但是 es 的配置可以通过 API 进行修改</li>\n<li>solr 所有配置保存在 <em>solrconfig.xml</em></li>\n<li>修改配置文件都需要重启生效</li>\n</ul>\n<h3 id=\"node-discovery\"><a class=\"markdownIt-Anchor\" href=\"#node-discovery\">#</a> Node Discovery</h3>\n<ul>\n<li>es 采用自带的 Zen；主节点可以作为协调节点只负责集群的管理</li>\n<li>Solr 使用 zookeeper 集成；zk 负责数据监控和存储配置文件</li>\n</ul>\n<h3 id=\"shard-placement\"><a class=\"markdownIt-Anchor\" href=\"#shard-placement\">#</a> Shard Placement</h3>\n<ul>\n<li>es 索引和分片的放置都是动态的。一个节点添加或删除，都可以动态修改分片的位置（迁移需要一定的时间）</li>\n<li>solr 更倾向于静态的。一个节点添加或删除，通过不做任何处理（solr7 之后通过 AutoScaling API 控制）</li>\n</ul>\n<h3 id=\"cache\"><a class=\"markdownIt-Anchor\" href=\"#cache\">#</a> Cache</h3>\n<ul>\n<li>es 的 cache 按 segment 进行。segment 发生变化，对应的 cache 失效，进行 refresh</li>\n<li>solr 的 cache 按分片划分。segment 发生变化，整个 cache 刷新（非常耗费时间和硬件资源）</li>\n</ul>\n",
            "tags": [
                "数据库"
            ]
        }
    ]
}